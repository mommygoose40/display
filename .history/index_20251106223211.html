çœ‹ä¸€ä¸‹æ‰‹æŒ‡ç¸®æ”¾çš„é‚è¼¯æ˜¯æ€éº¼å¯«çš„ï¼Œå› ç‚ºæ‰‹æŒ‡ç¸®æ”¾ä¸æœƒ100åˆ°110%çªç„¶è·³å¾ˆå¤§ï¼Œå…¶ä»–é›»è…¦ç‰ˆæ»‘é¼ ç¸®æ”¾è·ŸæŒ‰æ”¾å¤§æŒ‰éˆ•éƒ½æœƒçªç„¶æ”¾è¶…éæ”¾å¤§10%çš„å€ç‡: <!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é˜²æ±›é€šå ±ç³»çµ±</title>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getStorage, ref, list, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
  authDomain: "reportsystem-c5fc7.firebaseapp.com",
  projectId: "reportsystem-c5fc7",
  storageBucket: "reportsystem-c5fc7.firebasestorage.app",
  messagingSenderId: "845064058181",
  appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
  measurementId: "G-EDQM0LWQWH"
};

const app = initializeApp(firebaseConfig);
const storage = getStorage(app);

window.firebaseStorage = { storage, ref, list, listAll, getDownloadURL };
</script>

  <style>
    /* åŸºç¤æ¨£å¼ */
    body { 
        font-family: Arial, sans-serif; 
        margin: 0; 
        padding: 20px; 
        background: #f5f5f5; 
    }
    
    .container { 
        max-width: 800px; 
        margin: 0 auto; 
        background: white; 
        padding: 20px; 
        border-radius: 8px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        position: relative;
    }
    
    .header { 
        text-align: center; 
        margin-bottom: 20px; 
        padding-bottom: 15px; 
        border-bottom: 1px solid #ddd; 
    }
    
    .header p {
        font-size: 18px;
        margin: 8px 0;
    }
    
    .back-btn { 
        background: #4285f4; 
        color: white; 
        padding: 10px 15px; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        margin-bottom: 20px; 
    }
    
    .report-info p {
        margin: 8px 0;
        font-size: 20px;
    }
    
    /* ç…§ç‰‡ç¶²æ ¼ */
    .photo-gallery { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 25px; 
    }

    .photo-item { 
        border-radius: 8px; 
        overflow: hidden; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
        cursor: pointer; 
        aspect-ratio: 1;
        background-color: #f5f5f5;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .photo-item img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        display: block;
        transition: transform 0.3s ease;
    }

    .photo-item:hover img {
        transform: scale(1.05);
    }
    
    /* èªéŸ³å€å¡Š */
    .audio-player h3 {
        font-size: 24px;
    }
    
    .transcription-section { 
        background: #f9f9f9; 
        padding: 20px; 
        border-radius: 8px; 
        margin-bottom: 25px; 
        border: 1px solid #ddd; 
    }
    
    .transcription-text { 
        background: white; 
        padding: 15px; 
        border-radius: 8px; 
        border: 1px solid #eee; 
        margin-top: 10px; 
        white-space: pre-wrap; 
        line-height: 1.5; 
        max-height: 300px; 
        overflow-y: auto; 
    }
    
    .download-link { 
        display: inline-block; 
        margin-top: 10px; 
        color: #4285f4; 
        text-decoration: none; 
        font-weight: bold; 
    }
    
    .download-link:hover { 
        text-decoration: underline; 
    }
    
    .error { 
        text-align: center; 
        color: #d32f2f; 
        font-size: 18px; 
        padding: 40px; 
    }
    
    /* æ¨¡æ…‹æ¡†æ¨£å¼ - æ”¹é€²ç‰ˆæœ¬ */
    .modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  overflow: hidden;
  touch-action: none;
  pointer-events: auto; /* ä¿ç•™èƒŒæ™¯å¯è¢«é—œé–‰ */
}

    /* ç¢ºä¿åœ–ç‰‡å®¹å™¨å›ºå®š */
    .modal-content-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100%;
  cursor: default;
  overflow: hidden;
  pointer-events: none; /* â† è®“äº‹ä»¶å‚³çµ¦è£¡é¢çš„åœ–ç‰‡ */
}

    .modal-content {
  width: auto;
  height: auto;
  max-width: 90vw;
  max-height: 80vh;
  object-fit: contain;
  cursor: zoom-in;
  touch-action: none; /* è®“ JS æ§åˆ¶ pinch */
  pointer-events: auto; /* â† é—œéµï¼šåœ–ç‰‡æ¥æ”¶æ‰‹æŒ‡ç¸®æ”¾èˆ‡æ‹–æ›³ */
}

.modal-content.zoomed {
  cursor: grab;
  max-width: none !important;
  max-height: none !important;
  width: auto !important;
  height: auto !important;
}

    .modal-content.zoomed:active {
        cursor: grabbing;
    }

    /* é›»è…¦ç‰ˆèƒŒæ™¯é»æ“Šå€åŸŸ */
    @media (min-width: 769px) {
        .modal-content-container::before,
        .modal-content-container::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 30%;
            background: transparent;
            z-index: 1;
            cursor: pointer;
        }
        
        .modal-content-container::before {
            left: 0;
        }
        
        .modal-content-container::after {
            right: 0;
        }
    }
    
    .close {
        position: fixed;
        top: 25px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
        background: rgba(0,0,0,0.5);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
    }

    .close:hover {
        background: rgba(0,0,0,0.7);
    }
    
    .navigation {
        position: absolute;
        top: 50%;
        width: 100%;
        display: flex;
        justify-content: space-between;
        transform: translateY(-50%);
        pointer-events: none;
        z-index: 3;
    }
    
    .nav-btn {
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 20px 15px;
        font-size: 24px;
        cursor: pointer;
        pointer-events: auto;
        margin: 0 10px;
        border-radius: 5px;
        transition: all 0.3s ease;
        z-index: 4;
    }
    
    .nav-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        pointer-events: none;
    }

    .nav-btn:not(.disabled):hover {
        background: rgba(0,0,0,0.7);
        transform: scale(1.1);
    }
    
    /* è¼‰å…¥ä¸­æ¨£å¼ */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #666;
        grid-column: 1 / -1;
    }
    
    .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #ccc;
        border-top: 3px solid #0b5ed7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin { 
        from { transform: rotate(0deg); } 
        to { transform: rotate(360deg); } 
    }
    
    /* é€²åº¦æ¢æ¨£å¼ */
    .progress-bar {
        flex: 1;
        height: 12px;
        background: #eee;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        max-width: 400px;
    }
    
    .progress-bar:hover {
        background: #e0e0e0;
    }
    
    .progress-fill {
        width: 0%;
        height: 100%;
        background: #0b5ed7;
        transition: width 0.1s ease;
    }
    
    /* é é¢é—œé–‰æŒ‰éˆ• */
    .page-close-btn {
        position: fixed;
        top: 25px;
        right: 25px;
        color: #666;
        font-size: 36px;
        font-weight: bold;
        cursor: pointer;
        z-index: 999;
        transition: all 0.3s ease;
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .page-close-btn:hover {
        transform: scale(1.2);
        color: #333;
    }
    
    /* ç…§ç‰‡è¼‰å…¥å„ªåŒ– */
    .photo-item.loading img {
        opacity: 0;
    }
    
    .photo-item.loaded img {
        opacity: 1;
    }

    /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
    @media (max-width: 768px) {
        body {
            padding: 10px;
            background: white;
        }
        
        .container {
            padding: 15px;
            border-radius: 0;
            box-shadow: none;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .header p {
            font-size: 16px;
        }
        
        .report-info p {
            font-size: 18px;
        }
        
        .modal-content {
            max-width: 95vw;
            max-height: 80vh;
        }
        
        .nav-btn {
            padding: 15px 10px;
            font-size: 20px;
            margin: 0 5px;
        }
        
        .close {
            top: 15px;
            right: 20px;
            width: 40px;
            height: 40px;
            font-size: 30px;
        }
        
        /* æ‰‹æ©Ÿç‰ˆç§»é™¤èƒŒæ™¯é»æ“Šå€åŸŸ */
        .modal-content-container::before,
        .modal-content-container::after {
            display: none;
        }
    }

    /* ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• */
    .zoom-controls {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 1001;
        background: rgba(0,0,0,0.7);
        padding: 10px 15px;
        border-radius: 25px;
        align-items: center;
    }

    .zoom-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .zoom-btn.reset {
        width: auto;
        padding: 0 15px;
        border-radius: 22px;
        font-size: 14px;
        font-weight: normal;
    }

    .zoom-btn:hover {
        background: rgba(255,255,255,0.4);
        transform: scale(1.1);
    }

    .zoom-indicator {
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 60px;
        font-size: 14px;
        font-weight: bold;
    }
</style>
</head>

<body>
  <div class="container">
    <!-- å›ºå®šåœ¨å³ä¸Šè§’çš„é—œé–‰æŒ‰éˆ• -->
    <div class="page-close-btn" onclick="closePage()">&times;</div>

    <button class="back-btn" id="backButton" onclick="handleBack()" style="display: none;">â† è¼‰å…¥ä¸­...</button>

    <div class="header">
        <h1>é€šå ±è©³ç´°ç´€éŒ„</h1>
        <p id="report-date">å›å ±æ™‚é–“ï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div class="report-info">
        <p id="report-type">é€šå ±é¡å‹ï¼šè¼‰å…¥ä¸­...</p>
        <p id="report-status">ç‹€æ…‹ï¼šè¼‰å…¥ä¸­...</p>
        <p id="abnormal-type" style="display:none;">ç•°å¸¸åˆ†é¡ï¼šè¼‰å…¥ä¸­...</p>
        <p id="remarks">èªªæ˜ï¼šè¼‰å…¥ä¸­...</p>
        <p id="transcription-summary" style="display:none;">èªéŸ³è½‰æ–‡å­—ï¼šè¼‰å…¥ä¸­...</p>
        <p id="reporter">å›å ±è€…ï¼šè¼‰å…¥ä¸­...</p>
        <p id="companions">åŒè¡Œè€…ï¼šè¼‰å…¥ä¸­...</p>
        <p id="team">æ‰€å±¬å¤§éšŠï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div id="photo-section">
      <h2>ç…§ç‰‡</h2>
      <div id="photo-gallery" class="photo-gallery">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <span class="loading-text">ç…§ç‰‡è¼‰å…¥ä¸­...</span>
        </div>
      </div>
    </div>

    <div id="audio-section" style="display:none;">
      <div class="audio-player">
        <h3>èªéŸ³</h3>
        <div style="display:flex;align-items:center;gap:14px;margin:20px 0;max-width:500px;">
          <button id="playBtn" style="
            width:56px;height:56px;border-radius:50%;
            border:none;background:#0b5ed7;color:#fff;
            cursor:pointer;display:flex;align-items:center;justify-content:center;">
            <div id="playIcon" style="
              width:0;height:0;border-top:9px solid transparent;
              border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;">
            </div>
          </button>

          <span id="timeLabel" style="font-size:19px;color:#333;min-width:45px;">0:00</span>

          <div style="flex:1;height:12px;background:#eee;border-radius:8px;overflow:hidden;cursor:pointer;" id="progressBar">
            <div id="waveFill" style="width:0%;height:100%;background:#0b5ed7;"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="transcription-section" class="transcription-section" style="display:none;">
      <h3>ğŸ—£ï¸ èªéŸ³è½‰æ–‡å­—çµæœ</h3>
      <div id="transcription-text" class="transcription-text"></div>
      <a id="transcription-download" href="#" class="download-link">ğŸ“¥ ä¸‹è¼‰æ–‡å­—æª”</a>
    </div>

    <!-- ä¿®æ”¹ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• -->
  <div id="image-modal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <div class="modal-content-container" id="modalContainer">
        <img class="modal-content" id="modal-image">
    </div>
    <div class="navigation">
        <button class="nav-btn" onclick="navigatePhoto(-1)">&#10094;</button>
        <button class="nav-btn" onclick="navigatePhoto(1)">&#10095;</button>
    </div>
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
        <button class="zoom-btn reset" onclick="resetZoom()">å›å¾©åŸç‹€</button>
        <div class="zoom-indicator">100%</div>
        <button class="zoom-btn" onclick="zoomIn()">+</button>
    </div>
  </div>
  </div>

   <script>
let currentIndex = 0, currentPhotoUrls = [], currentReportId = '', pageSource = '';
let isZoomed = false;
let currentScale = 1;
let currentTranslateX = 0, currentTranslateY = 0;
let isDragging = false;
let dragStartX = 0, dragStartY = 0;
let isKeyboardCooldown = false;
const keyboardCooldownTime = 300;

document.addEventListener('DOMContentLoaded', () => {
  const temp = localStorage.getItem('tempReportData');
  if (temp) {
    try {
      const data = JSON.parse(temp);
      handleResponse(data);
    } catch (e) {
      console.warn('æš«å­˜è³‡æ–™è§£æå¤±æ•—:', e);
    }
    localStorage.removeItem('tempReportData');
  }

  const urlParams = new URLSearchParams(window.location.search);
  const reportId = urlParams.get('id');
  pageSource = urlParams.get('source');
  if (reportId) {
    currentReportId = reportId;
    setupBackButton();
    loadReportData(reportId);
  } else showError('éŒ¯èª¤ï¼šæœªæä¾›å ±å‘ŠID');
});

function setupBackButton() {
  const btn = document.getElementById('backButton');
  btn.style.display = 'block';
  btn.innerHTML = pageSource === 'form' ? 'â† è¿”å›è¡¨å–®' : 'â† è¿”å›';
}

function handleBack() {
  const btn = document.getElementById('backButton');
  btn.innerHTML = 'â† è¿”å›ä¸­...';
  btn.disabled = true;
  if (pageSource === 'form') location.href = 'https://report-tan-tau.vercel.app/';
  else if (document.referrer && document.referrer.includes(location.hostname)) history.back();
  else location.href = 'https://report-tan-tau.vercel.app/';
}

async function loadReportData(reportId) {
  try {
    document.getElementById('report-date').innerHTML = `å›å ±æ™‚é–“ï¼š${formatDateFromId(reportId)}`;
    await loadReportInfoFromSheet(reportId);
    await loadPhotosFromFirebase(reportId);
    await loadAudioFromFirebase(reportId);
    await loadTranscriptionFromFirebase(reportId);
  } catch (e) {
    console.error(e);
    showError('è¼‰å…¥æ•¸æ“šå¤±æ•—');
  }
}

function handleResponse(data) {
  if (!data || data.error) return showError('æŸ¥ç„¡æ­¤å ±å‘Šè³‡æ–™');
  const els = ['report-type', 'report-status', 'abnormal-type', 'remarks',
               'transcription-summary', 'reporter', 'companions', 'team'];
  els.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.color = '';
  });

  document.getElementById('report-type').innerHTML = `é€šå ±é¡å‹ï¼š${data['é€šå ±é¡å‹'] || 'ç„¡'}`;
  document.getElementById('report-status').innerHTML = `ç‹€æ…‹ï¼š${data['ç‹€æ…‹'] || 'ç„¡'}`;
  if (data['ç‹€æ…‹'] === 'ç•°å¸¸') {
    document.getElementById('abnormal-type').style.display = 'block';
    document.getElementById('abnormal-type').innerHTML = `ç•°å¸¸åˆ†é¡ï¼š${data['ç•°å¸¸åˆ†é¡'] || 'ç„¡'}`;
    document.getElementById('transcription-summary').style.display = 'block';
    document.getElementById('transcription-summary').innerHTML = `èªéŸ³è½‰æ–‡å­—ï¼š${data['èªéŸ³è½‰æ–‡å­—'] || 'ç„¡'}`;
  } else {
    document.getElementById('abnormal-type').style.display = 'none';
    document.getElementById('transcription-summary').style.display = 'none';
  }

  document.getElementById('remarks').innerHTML = `èªªæ˜ï¼š${data['èªªæ˜'] || 'ç„¡'}`;
  document.getElementById('reporter').innerHTML = `å›å ±è€…ï¼š${data['å›å ±è€…'] || 'ç„¡'}`;
  document.getElementById('companions').innerHTML = `åŒè¡Œè€…ï¼š${data['åŒè¡Œè€…'] || 'ç„¡'}`;
  document.getElementById('team').innerHTML = `æ‰€å±¬å¤§éšŠï¼š${data['æ‰€å±¬å¤§éšŠ'] || 'ç„¡'}`;
}

async function loadReportInfoFromSheet(reportId) {
  const url = `https://script.google.com/macros/s/AKfycby1hGsemrBwyFJvDRV5qcooS0t5qOoODHqU_9Rk9HvFBsP39Uzd2rtBqPFjj3S0_CyILg/exec?id=${reportId}&callback=handleResponse`;
  const script = document.createElement('script');
  script.src = url;
  document.body.appendChild(script);
}

function formatDateFromId(reportId) {
  const t = parseInt(reportId.replace('report_', ''));
  return isNaN(t) ? 'æœªçŸ¥æ™‚é–“' : new Date(t).toLocaleString('zh-TW');
}

// === ç…§ç‰‡è™•ç† ===
async function loadPhotosFromFirebase(reportId) {
  try {
    const { ref, list, getDownloadURL } = window.firebaseStorage;
    const storageRef = ref(window.firebaseStorage.storage, `reports/${reportId}/`);
    let pageToken = null;
    let allUrls = [];

    do {
      const result = await list(storageRef, { maxResults: 50, pageToken });
      const validItems = result.items
        .filter(item => /\.(jpg|jpeg|png|gif|webp|heic)$/i.test(item.name))
        .sort((a, b) => {
          const numA = parseInt(a.name.match(/photo_(\d+)/)?.[1] || '0');
          const numB = parseInt(b.name.match(/photo_(\d+)/)?.[1] || '0');
          return numA - numB;
        });

      for (const f of validItems) {
        try {
          const url = await getDownloadURL(f);
          if (url && url.startsWith('https')) allUrls.push(url);
        } catch {}
      }

      pageToken = result.nextPageToken;
    } while (pageToken);

    displayPhotos(allUrls);
  } catch (e) {
    console.error("âŒ è¼‰å…¥ç…§ç‰‡éŒ¯èª¤:", e);
    document.getElementById('photo-gallery').innerHTML =
      '<p style="color:#666;text-align:center;font-size:18px;">è¼‰å…¥ç…§ç‰‡å¤±æ•—</p>';
  }
}

function displayPhotos(urls) {
  const g = document.getElementById('photo-gallery');
  g.innerHTML = '';
  if (!urls || urls.length === 0) {
    g.innerHTML = '<p style="text-align:center;color:#666;font-size:18px;">æ­¤å›å ±æ²’æœ‰ç…§ç‰‡</p>';
    return;
  }

  urls.forEach((u, i) => {
    const d = document.createElement('div');
    d.className = 'photo-item loading';
    const img = new Image();
    img.onload = () => { d.classList.remove('loading'); d.classList.add('loaded'); };
    img.onerror = () => { d.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">âŒ è¼‰å…¥å¤±æ•—</div>'; };
    img.src = u;
    img.alt = `ç…§ç‰‡ ${i + 1}`;
    d.appendChild(img);
    d.onclick = () => openModal(i, urls);
    g.appendChild(d);
  });
}

// === æ¨¡æ…‹æ¡† ===
function openModal(i, urls) {
  currentIndex = i;
  currentPhotoUrls = urls;
  const m = document.getElementById('image-modal');
  const modalImg = document.getElementById('modal-image');
  const modalContainer = document.getElementById('modalContainer');

  resetZoomImmediate();
  modalImg.src = urls[i];
  m.style.display = 'block';
  updateModalNavButtons();

  setupTouchZoom(modalImg);
  setupSwipeNavigation(modalContainer);
  enableDragForZoomedImage(modalImg);
}

function closeModal() {
  document.getElementById('image-modal').style.display = 'none';
  resetZoom();
}

// === æ‰‹æ©Ÿé›™æŒ‡ç¸®æ”¾ ===
function setupTouchZoom(modalImg) {
  let initialDistance = 0;
  let initialScale = 1;
  let initialX = 0, initialY = 0;

  modalImg.addEventListener('touchstart', e => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const [t1, t2] = e.touches;
      initialDistance = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
      initialScale = currentScale;
      initialX = (t1.clientX + t2.clientX) / 2;
      initialY = (t1.clientY + t2.clientY) / 2;
    }
  }, { passive: false });

  modalImg.addEventListener('touchmove', e => {
    if (e.touches.length === 2 && initialDistance > 0) {
      e.preventDefault();
      const [t1, t2] = e.touches;
      const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
      const factor = dist / initialDistance;
      const newScale = Math.max(1, Math.min(2.0, initialScale * factor));
      handlePinchZoom(newScale, initialX, initialY);
    }
  }, { passive: false });

  modalImg.addEventListener('touchend', () => { initialDistance = 0; });
}

function handlePinchZoom(newScale, cx, cy) {
  const modalImg = document.getElementById('modal-image');
  const container = document.getElementById('modalContainer');
  const oldScale = currentScale;
  currentScale = newScale;
  isZoomed = currentScale > 1.0;

  const rect = container.getBoundingClientRect();
  const imgRect = modalImg.getBoundingClientRect();
  const offsetX = cx - (imgRect.left + imgRect.width / 2);
  const offsetY = cy - (imgRect.top + imgRect.height / 2);

  currentTranslateX -= offsetX * (currentScale / oldScale - 1);
  currentTranslateY -= offsetY * (currentScale / oldScale - 1);

  constrainTranslation();
  applyTransform();
  updateZoomIndicator();
}

// === transform èˆ‡æ‹–æ›³ ===
function applyTransform() {
  const modalImg = document.getElementById('modal-image');
  modalImg.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
}

function constrainTranslation() {
  const modalImg = document.getElementById('modal-image');
  const container = document.getElementById('modalContainer');
  const containerRect = container.getBoundingClientRect();
  const imgRect = modalImg.getBoundingClientRect();

  const displayWidth = imgRect.width * currentScale;
  const displayHeight = imgRect.height * currentScale;
  const maxTranslateX = Math.max(0, (displayWidth - containerRect.width) / 2);
  const maxTranslateY = Math.max(0, (displayHeight - containerRect.height) / 2);

  currentTranslateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, currentTranslateX));
  currentTranslateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, currentTranslateY));
}

// === æ‹–æ›³ï¼ˆæ»‘é¼  + æ‰‹æ©Ÿï¼‰ ===
function enableDragForZoomedImage(img) {
  img.addEventListener('mousedown', e => {
    if (!isZoomed) return;
    isDragging = true;
    dragStartX = e.clientX - currentTranslateX;
    dragStartY = e.clientY - currentTranslateY;
    img.style.cursor = 'grabbing';
    e.preventDefault();
  });

  document.addEventListener('mousemove', e => {
    if (!isDragging || !isZoomed) return;
    currentTranslateX = e.clientX - dragStartX;
    currentTranslateY = e.clientY - dragStartY;
    constrainTranslation();
    applyTransform();
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    if (isZoomed) img.style.cursor = 'grab';
  });

  let touchStart = null;
  img.addEventListener('touchstart', e => {
    if (isZoomed && e.touches.length === 1) {
      touchStart = {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY,
        translateX: currentTranslateX,
        translateY: currentTranslateY
      };
      e.preventDefault();
    }
  });

  img.addEventListener('touchmove', e => {
    if (isZoomed && e.touches.length === 1 && touchStart) {
      const dx = e.touches[0].clientX - touchStart.x;
      const dy = e.touches[0].clientY - touchStart.y;
      currentTranslateX = touchStart.translateX + dx;
      currentTranslateY = touchStart.translateY + dy;
      constrainTranslation();
      applyTransform();
      e.preventDefault();
    }
  });

  img.addEventListener('touchend', () => { touchStart = null; });
}

// === å…¶ä»–æ§åˆ¶ ===
function resetZoomImmediate() {
  const modalImg = document.getElementById('modal-image');
  isZoomed = false;
  currentScale = 1;
  currentTranslateX = 0;
  currentTranslateY = 0;
  modalImg.style.transition = 'none';
  modalImg.style.transform = 'translate(0, 0) scale(1)';
  modalImg.classList.remove('zoomed');
  updateZoomIndicator();
  requestAnimationFrame(() => {
    modalImg.style.transition = 'transform 0.2s ease-out';
  });
}

function updateZoomIndicator() {
  const indicator = document.querySelector('.zoom-indicator');
  if (indicator) indicator.textContent = Math.round(currentScale * 100) + '%';
}
</script>
</body>
</html>