<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é˜²æ±›é€šå ±ç³»çµ±</title>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getStorage, ref, list, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
  authDomain: "reportsystem-c5fc7.firebaseapp.com",
  projectId: "reportsystem-c5fc7",
  storageBucket: "reportsystem-c5fc7.firebasestorage.app",
  messagingSenderId: "845064058181",
  appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
  measurementId: "G-EDQM0LWQWH"
};

const app = initializeApp(firebaseConfig);
const storage = getStorage(app);

window.firebaseStorage = { storage, ref, list, listAll, getDownloadURL };
</script>

  <style>
    /* åŸºç¤æ¨£å¼ */
    body { 
        font-family: Arial, sans-serif; 
        margin: 0; 
        padding: 20px; 
        background: #f5f5f5; 
    }
    
    .container { 
        max-width: 800px; 
        margin: 0 auto; 
        background: white; 
        padding: 20px; 
        border-radius: 8px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        position: relative;
    }
    
    .header { 
        text-align: center; 
        margin-bottom: 20px; 
        padding-bottom: 15px; 
        border-bottom: 1px solid #ddd; 
    }
    
    .header p {
        font-size: 18px;
        margin: 8px 0;
    }
    
    .report-info p {
        margin: 8px 0;
        font-size: 20px;
    }

    /* å¯ç·¨è¼¯æ¬„ä½æ¨£å¼ */
    .editable-field {
        border: 1px solid transparent;
        padding: 2px 5px;
        border-radius: 4px;
        transition: all 0.3s ease;
        cursor: text;
    }
    
    .editable-field[contenteditable="true"] {
        border: 1px solid #4285f4;
        background: #f8fbff;
        outline: none;
    }
    
    .editable-field[contenteditable="true"]:focus {
        border-color: #0b5ed7;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }
    
    /* ç…§ç‰‡ç¶²æ ¼ */
    .photo-gallery { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 25px; 
    }

    .photo-item { 
        border-radius: 8px; 
        overflow: hidden; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
        cursor: pointer; 
        aspect-ratio: 1;
        background-color: #f5f5f5;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .photo-item img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        display: block;
        transition: transform 0.3s ease;
    }

    .photo-item:hover img {
        transform: scale(1.05);
    }
    
    /* èªéŸ³å€å¡Š */
    .audio-player h3 {
        font-size: 24px;
    }
    
    .transcription-section { 
        background: #f9f9f9; 
        padding: 20px; 
        border-radius: 8px; 
        margin-bottom: 25px; 
        border: 1px solid #ddd; 
    }
    
    .transcription-text { 
        background: white; 
        padding: 15px; 
        border-radius: 8px; 
        border: 1px solid #eee; 
        margin-top: 10px; 
        white-space: pre-wrap; 
        line-height: 1.5; 
        max-height: 300px; 
        overflow-y: auto; 
    }

    /* ç·¨è¼¯å€åŸŸæ¨£å¼ */
    .transcription-text[contenteditable="true"] {
        border: 2px solid #4285f4;
        background: #f8fbff;
        min-height: 120px;
        padding: 15px;
        border-radius: 8px;
        outline: none;
    }

    .transcription-text[contenteditable="true"]:focus {
        border-color: #0b5ed7;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }

    .save-btn, .reset-btn {
        background: #4285f4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px;
        font-size: 16px;
        transition: background 0.3s ease;
    }

    .reset-btn {
        background: #6c757d;
    }

    .save-btn:hover {
        background: #0b5ed7;
    }

    .reset-btn:hover {
        background: #5a6268;
    }
    
    .download-link { 
        display: inline-block; 
        margin-top: 10px; 
        color: #4285f4; 
        text-decoration: none; 
        font-weight: bold; 
    }
    
    .download-link:hover { 
        text-decoration: underline; 
    }
    
    .error { 
        text-align: center; 
        color: #d32f2f; 
        font-size: 18px; 
        padding: 40px; 
    }
    
    /* åº•éƒ¨æŒ‰éˆ•å€å¡Š */
    .mobile-footer-buttons {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 15px 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    
    .footer-btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin: 0 5px;
        transition: all 0.3s ease;
    }
    
    .footer-back-btn {
        background: #6c757d;
        color: white;
    }
    
    .footer-close-btn {
        background: #4285f4;
        color: white;
    }
    
    .footer-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .footer-back-btn:hover {
        background: #5a6268;
    }
    
    .footer-close-btn:hover {
        background: #0b5ed7;
    }

    /* åŒæ­¥ç·¨è¼¯æç¤º */
    .sync-notice {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        border-radius: 5px;
        padding: 10px;
        margin: 10px 0;
        font-size: 14px;
        color: #2e7d32;
        display: none;
    }
    
    /* æ¨¡æ…‹æ¡†æ¨£å¼ - æ”¹é€²ç‰ˆæœ¬ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        overflow: hidden;
        touch-action: none;
    }

    /* ç¢ºä¿åœ–ç‰‡å®¹å™¨å›ºå®š */
    .modal-content-container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        cursor: default;
        overflow: hidden;
    }

    .modal-content {
        display: block;
        max-width: 90vw;
        max-height: 80vh;
        object-fit: contain;
        transition: none;
        cursor: default;
        transform-origin: center center;
        will-change: transform;
        user-select: none;
        -webkit-user-drag: none;
    }

    .modal-content.zoomed {
        cursor: grab;
        max-width: none;
        max-height: none;
    }

    .modal-content.zoomed:active {
        cursor: grabbing;
    }

    /* é›»è…¦ç‰ˆèƒŒæ™¯é»æ“Šå€åŸŸ */
    @media (min-width: 769px) {
        .modal-content-container::before,
        .modal-content-container::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 30%;
            background: transparent;
            z-index: 1;
            cursor: pointer;
        }
        
        .modal-content-container::before {
            left: 0;
        }
        
        .modal-content-container::after {
            right: 0;
        }
    }
    
    .close {
        position: absolute;
        top: 25px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
        background: rgba(0,0,0,0.5);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
    }

    .close:hover {
        background: rgba(0,0,0,0.7);
    }
    
    .navigation {
        position: absolute;
        top: 50%;
        width: 100%;
        display: flex;
        justify-content: space-between;
        transform: translateY(-50%);
        pointer-events: none;
        z-index: 3;
    }
    
    .nav-btn {
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 20px 15px;
        font-size: 24px;
        cursor: pointer;
        pointer-events: auto;
        margin: 0 10px;
        border-radius: 5px;
        transition: all 0.3s ease;
        z-index: 4;
    }
    
    .nav-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        pointer-events: none;
    }

    .nav-btn:not(.disabled):hover {
        background: rgba(0,0,0,0.7);
        transform: scale(1.1);
    }
    
    /* è¼‰å…¥ä¸­æ¨£å¼ */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #666;
        grid-column: 1 / -1;
    }
    
    .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #ccc;
        border-top: 3px solid #0b5ed7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin { 
        from { transform: rotate(0deg); } 
        to { transform: rotate(360deg); } 
    }
    
    /* é€²åº¦æ¢æ¨£å¼ */
    .progress-bar {
        flex: 1;
        height: 12px;
        background: #eee;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        max-width: 400px;
    }
    
    .progress-bar:hover {
        background: #e0e0e0;
    }
    
    .progress-fill {
        width: 0%;
        height: 100%;
        background: #0b5ed7;
        transition: width 0.1s ease;
    }
    
    /* ç…§ç‰‡è¼‰å…¥å„ªåŒ– */
    .photo-item.loading img {
        opacity: 0;
    }
    
    .photo-item.loaded img {
        opacity: 1;
    }

    /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
    @media (max-width: 768px) {
        body {
            padding: 10px;
            background: white;
            padding-bottom: 80px; /* ç‚ºåº•éƒ¨æŒ‰éˆ•ç•™ç©ºé–“ */
        }
        
        .container {
            padding: 15px;
            border-radius: 0;
            box-shadow: none;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .header p {
            font-size: 16px;
        }
        
        .report-info p {
            font-size: 18px;
        }

        /* æ‰‹æ©Ÿç‰ˆå¯ç·¨è¼¯æ¬„ä½ */
        .editable-field {
            font-size: 18px;
            padding: 3px 8px;
            min-height: 24px;
        }
        
        .modal-content {
            max-width: 95vw;
            max-height: 80vh;
        }
        
        .nav-btn {
            padding: 15px 10px;
            font-size: 20px;
            margin: 0 5px;
        }
        
        .close {
            top: 15px;
            right: 20px;
            width: 40px;
            height: 40px;
            font-size: 30px;
        }
        
        /* é¡¯ç¤ºåº•éƒ¨æŒ‰éˆ• */
        .mobile-footer-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* æ‰‹æ©Ÿç‰ˆèªéŸ³æ’­æ”¾å™¨å„ªåŒ– */
        .audio-player {
            margin-bottom: 20px;
        }

        /* æ‰‹æ©Ÿç‰ˆç·¨è¼¯æŒ‰éˆ• */
        .save-btn, .reset-btn {
            font-size: 18px;
            padding: 12px 24px;
            margin-bottom: 10px;
        }

        /* åŒæ­¥ç·¨è¼¯æç¤ºæ‰‹æ©Ÿç‰ˆ */
        .sync-notice {
            font-size: 16px;
            padding: 12px;
        }
        
        /* æ‰‹æ©Ÿç‰ˆç§»é™¤èƒŒæ™¯é»æ“Šå€åŸŸ */
        .modal-content-container::before,
        .modal-content-container::after {
            display: none;
        }
    }

    /* ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• */
    .zoom-controls {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 1001;
        background: rgba(0,0,0,0.7);
        padding: 10px 15px;
        border-radius: 25px;
        align-items: center;
    }

    /* åªèª¿æ•´æ‰‹æ©Ÿç«¯ */
    @media (max-width: 768px) {
        .nav-btn {
            padding: 20px 15px;
            font-size: 24px;
            margin: 0 10px;
            border-radius: 5px;
        }
        
        .zoom-controls {
            gap: 16px;
            padding: 14px 20px;
            bottom: 25px;
        }
        
        .zoom-btn {
            width: 44px;
            height: 44px;
            font-size: 20px;
        }
        
        /* å›å¾©åŸç‹€æŒ‰éˆ• */
        .zoom-btn.reset {
            height: 44px;
            padding: 0 16px;
            font-size: 20px !important;
            white-space: nowrap;
            font-weight: normal;
        }
        
        /* æ–‡å­—æŒ‡ç¤ºå™¨ */
        .zoom-indicator {
            min-width: 100px;
            font-size: 20px !important;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 44px;
            background: transparent;
            color: white;
            border: none;
            box-shadow: none;
            cursor: default;
            pointer-events: none;
        }
        
        /* æ‰‹æ©Ÿç«¯éš±è—åŠ æ¸›æŒ‰éˆ• */
        .zoom-btn:first-child,
        .zoom-btn:last-child {
            display: none;
        }
    }

    .zoom-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .zoom-btn.reset {
        width: auto;
        padding: 0 15px;
        border-radius: 22px;
        font-size: 14px;
        font-weight: normal;
        display: none;
    }

    .zoom-btn:hover {
        background: rgba(255,255,255,0.4);
        transform: scale(1.1);
    }

    .zoom-indicator {
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 60px;
        font-size: 14px;
        font-weight: bold;
    }

    /* ç§»é™¤åŸæœ¬çš„æŒ‰éˆ• */
    .back-btn, .page-close-btn {
        display: none !important;
    }
</style>
</head>

<body>
  <div class="container">
    <!-- å›ºå®šåœ¨å³ä¸Šè§’çš„é—œé–‰æŒ‰éˆ• -->
    <div class="page-close-btn" onclick="closePage()">&times;</div>

    <button class="back-btn" id="backButton" onclick="handleBack()" style="display: none;">â† è¼‰å…¥ä¸­...</button>

    <div class="header">
        <h1>é€šå ±è©³ç´°ç´€éŒ„</h1>
        <p id="report-date">å›å ±æ™‚é–“ï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div class="report-info">
    <p id="report-type">é€šå ±é¡å‹ï¼šè¼‰å…¥ä¸­...</p>
    <p id="report-status">ç‹€æ…‹ï¼šè¼‰å…¥ä¸­...</p>
    <p id="abnormal-type" style="display:none;">ç•°å¸¸åˆ†é¡ï¼šè¼‰å…¥ä¸­...</p>
    <p id="remarks">èªªæ˜ï¼šè¼‰å…¥ä¸­...</p>
    <p id="transcription-summary" style="display:none;">
        èªéŸ³è½‰æ–‡å­—ï¼š<span class="editable-field" contenteditable="true" id="transcription-summary-text">è¼‰å…¥ä¸­...</span>
    </p>
    <p id="reporter">å›å ±è€…ï¼šè¼‰å…¥ä¸­...</p>
    <p id="companions">åŒè¡Œè€…ï¼šè¼‰å…¥ä¸­...</p>
    <p id="team">æ‰€å±¬å¤§éšŠï¼šè¼‰å…¥ä¸­...</p>
</div>

    <div id="photo-section">
      <h2>ç…§ç‰‡</h2>
      <div id="photo-gallery" class="photo-gallery">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <span class="loading-text">ç…§ç‰‡è¼‰å…¥ä¸­...</span>
        </div>
      </div>
    </div>

    <div id="audio-section" style="display:none;">
      <div class="audio-player">
        <h3>èªéŸ³</h3>
        <div style="display:flex;align-items:center;gap:14px;margin:20px 0;max-width:500px;">
          <button id="playBtn" style="
            width:56px;height:56px;border-radius:50%;
            border:none;background:#0b5ed7;color:#fff;
            cursor:pointer;display:flex;align-items:center;justify-content:center;">
            <div id="playIcon" style="
              width:0;height:0;border-top:9px solid transparent;
              border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;">
            </div>
          </button>

          <span id="timeLabel" style="font-size:19px;color:#333;min-width:45px;">0:00</span>

          <div style="flex:1;height:12px;background:#eee;border-radius:8px;overflow:hidden;cursor:pointer;" id="progressBar">
            <div id="waveFill" style="width:0%;height:100%;background:#0b5ed7;"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="transcription-section" class="transcription-section" style="display:none;">
    <h3>ğŸ—£ï¸ èªéŸ³è½‰æ–‡å­—çµæœ</h3>
    <div class="sync-notice">ğŸ’¡ ç·¨è¼¯æ­¤è™•å…§å®¹æœƒåŒæ­¥æ›´æ–°ä¸Šæ–¹çš„ã€ŒèªéŸ³è½‰æ–‡å­—ã€æ¬„ä½</div>
    <div id="transcription-text" class="transcription-text" contenteditable="true"></div>
    <div style="margin-top: 15px;">
        <button id="save-transcription" class="save-btn">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
        <button id="reset-transcription" class="reset-btn">â†º æ¢å¾©åŸå…§å®¹</button>
    </div>
    <a id="transcription-download" href="#" class="download-link">ğŸ“¥ ä¸‹è¼‰æ–‡å­—æª”</a>
</div>

    <!-- ä¿®æ”¹ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• -->
  <div id="image-modal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <div class="modal-content-container" id="modalContainer">
        <img class="modal-content" id="modal-image">
    </div>
    <div class="navigation">
        <button class="nav-btn" onclick="navigatePhoto(-1)">&#10094;</button>
        <button class="nav-btn" onclick="navigatePhoto(1)">&#10095;</button>
    </div>
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
        <button class="zoom-btn reset" onclick="resetZoom()">å›å¾©åŸç‹€</button>
        <div class="zoom-indicator">100%</div>
        <button class="zoom-btn" onclick="zoomIn()">+</button>
    </div>
  </div>

  <div class="mobile-footer-buttons">
    <button class="footer-btn footer-back-btn" onclick="handleBack()">è¿”å›è¡¨å–®</button>
    <button class="footer-btn footer-close-btn" onclick="closePage()">é—œé–‰é é¢</button>
</div>
  </div>

   <script>
    let baseScale = 1; // ç”¨ä¾†è¨˜éŒ„åœ–ç‰‡å‰›è¼‰å…¥æ™‚ fit çš„æ¯”ä¾‹
let visualScale = 1; // é¡¯ç¤ºç”¨æ¯”ä¾‹
    let currentIndex = 0, currentPhotoUrls = [], currentReportId = '', pageSource = '';
    let isZoomed = false;
    let currentScale = 1;
    let currentTranslateX = 0, currentTranslateY = 0;
    let isDragging = false;
    let dragStartX = 0, dragStartY = 0;
    let isKeyboardCooldown = false;
    const keyboardCooldownTime = 300;
    // åœ¨é ‚éƒ¨è®Šæ•¸å®£å‘Šå€åŸŸæ·»åŠ 
const zoomLevels = [1.0, 1.1, 1.25, 1.5, 1.75, 2.0, 2.5];
let currentZoomIndex = 0;
// åœ¨é ‚éƒ¨è®Šæ•¸å®£å‘Šå€åŸŸæ·»åŠ 
let hasUserZoomed = false;

    document.addEventListener('DOMContentLoaded', () => {
      const temp = localStorage.getItem('tempReportData');
      if (temp) {
        try {
          const data = JSON.parse(temp);
          console.log('âš¡ æ˜¾ç¤ºæš‚å­˜èµ„æ–™:', data);
          handleResponse(data);
        } catch (e) {
          console.warn('æš‚å­˜èµ„æ–™è§£æå¤±è´¥:', e);
        }
        localStorage.removeItem('tempReportData');
      }

      const urlParams = new URLSearchParams(window.location.search);
      const reportId = urlParams.get('id');
      pageSource = urlParams.get('source');
      if (reportId) {
        currentReportId = reportId;
        setupBackButton();
        loadReportData(reportId);
      } else showError('é”™è¯¯ï¼šæœªæä¾›æŠ¥å‘ŠID');
    });

    function setupBackButton() {
      const btn = document.getElementById('backButton');
      btn.style.display = 'block';
      btn.innerHTML = pageSource === 'form' ? 'â† è¿”å›è¡¨å•' : 'â† è¿”å›';
    }

    function handleBack() {
      const btn = document.getElementById('backButton');
      btn.innerHTML = 'â† è¿”å›ä¸­...';
      btn.disabled = true;
      if (pageSource === 'form') location.href = 'https://report-tan-tau.vercel.app/';
      else if (document.referrer && document.referrer.includes(location.hostname)) history.back();
      else location.href = 'https://report-tan-tau.vercel.app/';
    }

    async function loadReportData(reportId) {
      try {
        document.getElementById('report-date').innerHTML = `å›å ±æ™‚é–“ï¼š${formatDateFromId(reportId)}`;
        await loadReportInfoFromSheet(reportId);
        await loadPhotosFromFirebase(reportId);
        await loadAudioFromFirebase(reportId);
        await loadTranscriptionFromFirebase(reportId);
      } catch (e) {
        console.error(e);
        showError('è¼‰å…¥æ•¸æ“šå¤±æ•—');
      }
    }

    function handleResponse(data) {
  console.log('ğŸ“¥ JSONP å–å¾—:', data);
  if (!data || data.error) return showError('æŸ¥ç„¡æ­¤å ±å‘Šè³‡æ–™');

  const elements = ['report-type', 'report-status', 'abnormal-type', 'remarks', 
                   'transcription-summary', 'reporter', 'companions', 'team'];
  elements.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.color = '';
  });

  document.getElementById('report-type').innerHTML = `é€šå ±é¡å‹ï¼š${data['é€šå ±é¡å‹'] || 'ç„¡'}`;
  document.getElementById('report-status').innerHTML = `ç‹€æ…‹ï¼š${data['ç‹€æ…‹'] || 'ç„¡'}`;

  if (data['ç‹€æ…‹'] === 'ç•°å¸¸') {
    document.getElementById('abnormal-type').style.display = 'block';
    document.getElementById('abnormal-type').innerHTML = `ç•°å¸¸åˆ†é¡ï¼š${data['ç•°å¸¸åˆ†é¡'] || 'ç„¡'}`;
    document.getElementById('transcription-summary').style.display = 'block';
    
    // æ›´æ–°å¯ç·¨è¼¯çš„èªéŸ³è½‰æ–‡å­—æ¬„ä½
    const transcriptionSummaryText = document.getElementById('transcription-summary-text');
    if (transcriptionSummaryText) {
      transcriptionSummaryText.textContent = data['èªéŸ³è½‰æ–‡å­—'] || 'ç„¡';
    }
    
    // é¡¯ç¤ºåŒæ­¥ç·¨è¼¯æç¤º
    const syncNotice = document.querySelector('.sync-notice');
    if (syncNotice) {
      syncNotice.style.display = 'block';
    }
  } else {
    document.getElementById('abnormal-type').style.display = 'none';
    document.getElementById('transcription-summary').style.display = 'none';
  }

  document.getElementById('remarks').innerHTML = `èªªæ˜ï¼š${data['èªªæ˜'] || 'ç„¡'}`;
  document.getElementById('reporter').innerHTML = `å›å ±è€…ï¼š${data['å›å ±è€…'] || 'ç„¡'}`;
  document.getElementById('companions').innerHTML = `åŒè¡Œè€…ï¼š${data['åŒè¡Œè€…'] || 'ç„¡'}`;
  document.getElementById('team').innerHTML = `æ‰€å±¬å¤§éšŠï¼š${data['æ‰€å±¬å¤§éšŠ'] || 'ç„¡'}`;
}

    async function loadReportInfoFromSheet(reportId) {
      const url = `https://script.google.com/macros/s/AKfycby1hGsemrBwyFJvDRV5qcooS0t5qOoODHqU_9Rk9HvFBsP39Uzd2rtBqPFjj3S0_CyILg/exec?id=${reportId}&callback=handleResponse`;
      const script = document.createElement('script');
      script.src = url;
      document.body.appendChild(script);
    }

    function formatDateFromId(reportId) {
      const t = parseInt(reportId.replace('report_', ''));
      return isNaN(t) ? 'æœªçŸ¥æ™‚é–“' : new Date(t).toLocaleString('zh-TW');
    }

    async function loadPhotosFromFirebase(reportId) {
      try {
        const { ref, list, getDownloadURL } = window.firebaseStorage;
        const storageRef = ref(window.firebaseStorage.storage, `reports/${reportId}/`);
        let pageToken = null;
        let allUrls = [];

        do {
          const result = await list(storageRef, { maxResults: 50, pageToken });

          const validItems = result.items
            .filter(item => /\.(jpg|jpeg|png|gif|webp|heic)$/i.test(item.name))
            .sort((a, b) => {
              const numA = parseInt(a.name.match(/photo_(\d+)/)?.[1] || '0');
              const numB = parseInt(b.name.match(/photo_(\d+)/)?.[1] || '0');
              return numA - numB;
            });

          for (const f of validItems) {
            try {
              const url = await getDownloadURL(f);
              if (url && url.startsWith('https')) {
                allUrls.push(url);
              }
            } catch (err) {
              console.warn('è·³éå£æª”ï¼š', f.name, err.message);
            }
          }

          pageToken = result.nextPageToken;
        } while (pageToken);

        displayPhotos(allUrls);
        
      } catch (e) {
        console.error("âŒ è¼‰å…¥ç…§ç‰‡éŒ¯èª¤:", e);
        document.getElementById('photo-gallery').innerHTML =
          '<p style="color:#666;text-align:center;font-size:18px;">è¼‰å…¥ç…§ç‰‡å¤±æ•—</p>';
      }
    }

    function displayPhotos(urls) {
      const g = document.getElementById('photo-gallery');
      g.innerHTML = '';
      
      if (!urls || urls.length === 0) {
        g.innerHTML = '<p style="text-align:center;color:#666;font-size:18px;">æ­¤å›å ±æ²’æœ‰ç…§ç‰‡</p>';
        return;
      }
      
      urls.forEach((u, i) => {
        const d = document.createElement('div');
        d.className = 'photo-item loading';
        
        const img = new Image();
        img.style.cssText = 'width:100%;height:100%;object-fit:cover;background:#f5f5f5;transition:opacity 0.3s ease;';
        
        img.onload = function() {
          d.classList.remove('loading');
          d.classList.add('loaded');
        };
        
        img.onerror = function() {
          console.error('åœ–ç‰‡è¼‰å…¥å¤±æ•—:', u);
          d.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">âŒ è¼‰å…¥å¤±æ•—</div>';
          d.style.cursor = 'default';
        };
        
        img.src = u;
        img.alt = `ç…§ç‰‡ ${i + 1}`;
        
        d.appendChild(img);
        d.onclick = () => openModal(i, urls);
        g.appendChild(d);
      });
    }

    async function loadAudioFromFirebase(reportId) {
      const { ref, getDownloadURL } = window.firebaseStorage;
      const exts = ['.webm', '.mp3', '.wav', '.m4a'];

      for (const ext of exts) {
        try {
          const r = ref(window.firebaseStorage.storage, `reports/${reportId}/recording${ext}`);
          const url = await getDownloadURL(r);

          document.getElementById('audio-section').style.display = 'block';
          initCustomPlayer(url);
          console.log('ğŸ§ è¼‰å…¥éŸ³è¨Š:', url);
          break;
        } catch {}
      }
    }

    async function loadTranscriptionFromFirebase(reportId) {
      try {
        const { ref, getDownloadURL } = window.firebaseStorage;
        const tRef = ref(window.firebaseStorage.storage, `reports/${reportId}/transcription.txt`);
        const url = await getDownloadURL(tRef);
        const text = await (await fetch(url)).text();
        document.getElementById('transcription-section').style.display = 'block';
        document.getElementById('transcription-text').textContent = text;
        document.getElementById('transcription-download').href = url;
        document.getElementById('transcription-download').download = `transcription_${reportId}.txt`;
      } catch {}
    }

    function showError(msg) {
      document.getElementById('photo-gallery').innerHTML = `<div class="error">${msg}</div>`;
    }

    function openModal(i, urls) {
    currentIndex = i;
    currentPhotoUrls = urls;
    const m = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-image');
    const modalContainer = document.getElementById('modalContainer');

    // é‡ç½®ç‹€æ…‹
    resetZoomImmediate();
    hasUserZoomed = false;
    
    modalImg.src = urls[i];

    modalImg.onload = () => {
        modalImg.style.transform = 'translate(0, 0) scale(1)';
        modalImg.style.maxWidth = '90vw';
        modalImg.style.maxHeight = '80vh';
        modalImg.style.objectFit = 'contain';

        currentZoomIndex = 0;
        visualScale = zoomLevels[0];
        currentScale = visualScale;
        currentTranslateX = 0;
        currentTranslateY = 0;
        isZoomed = false;

        updateZoomIndicator();
        updateZoomButtons();
        updateResetButtonVisibility(); // åˆå§‹åŒ–æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
    };

    m.style.display = 'block';
    updateModalNavButtons();

    // å•Ÿç”¨æ»¾è¼ªç¸®æ”¾
    modalImg.removeEventListener('wheel', handleWheelZoom);
    modalImg.addEventListener('wheel', handleWheelZoom);

    // é›»è…¦ç‰ˆï¼šåªæœ‰å·¦å³30%å€åŸŸå¯ä»¥é»æ“Šåˆ‡æ›
if (window.innerWidth > 768) {
    modalContainer.onclick = function(e) {
        if (isZoomed) return;
        
        const rect = this.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;
        
        if (clickX < width * 0.3) {
            navigatePhoto(-1);
        } else if (clickX > width * 0.7) {
            navigatePhoto(1);
        }
    };
}

    // æ‰‹æ©Ÿç¸®æ”¾æ”¯æŒ
    setupTouchZoom(modalImg);

    // æ‰‹æ©Ÿæ»‘å‹•åˆ‡æ›
    setupSwipeNavigation(modalContainer);

    // å•Ÿç”¨æ‹–æ›³åŠŸèƒ½
    enableDragForZoomedImage(modalImg);
}

    function resetZoom() {
    const modalImg = document.getElementById('modal-image');
    isZoomed = false;
    currentZoomIndex = 0;
    visualScale = zoomLevels[0];
    currentScale = visualScale;
    currentTranslateX = 0;
    currentTranslateY = 0;
    hasUserZoomed = false; // é‡ç½®æ¨™è¨˜
    
    modalImg.style.transition = 'transform 0.2s ease-out';
    modalImg.style.transform = 'translate(0, 0) scale(1)';
    modalImg.classList.remove('zoomed');
    
    updateZoomIndicator();
    updateZoomButtons();
    updateResetButtonVisibility(); // éš±è—å›å¾©åŸç‹€æŒ‰éˆ•
}

    // ä¿®æ”¹ handleZoom å‡½æ•¸ï¼Œåµæ¸¬ç”¨æˆ¶ç¸®æ”¾è¡Œç‚º
function handleZoom(direction, clientX, clientY) {
    const modalImg = document.getElementById('modal-image');
    const container = document.getElementById('modalContainer');
    const oldVisual = visualScale;

    let newIndex = currentZoomIndex + direction;
    newIndex = Math.max(0, Math.min(zoomLevels.length - 1, newIndex));
    
    if (newIndex === currentZoomIndex) return;
    
    currentZoomIndex = newIndex;
    visualScale = zoomLevels[currentZoomIndex];
    currentScale = visualScale;
    isZoomed = visualScale > 1.0;
    
    // æ¨™è¨˜ç”¨æˆ¶æœ‰é€²è¡Œç¸®æ”¾æ“ä½œï¼ˆé™¤äº†å›åˆ°100%ï¼‰
    if (visualScale > 1.0) {
        hasUserZoomed = true;
    }
    
    // é¡¯ç¤º/éš±è—å›å¾©åŸç‹€æŒ‰éˆ•
    updateResetButtonVisibility();
    
    if (isZoomed) {
        modalImg.classList.add('zoomed');
    } else {
        modalImg.classList.remove('zoomed');
        currentTranslateX = 0;
        currentTranslateY = 0;
    }

    // ç¸®æ”¾è¨ˆç®—...
    const rect = container.getBoundingClientRect();
    const imgRect = modalImg.getBoundingClientRect();
    const cx = clientX ?? rect.left + rect.width / 2;
    const cy = clientY ?? rect.top + rect.height / 2;
    const offsetX = cx - (imgRect.left + imgRect.width / 2);
    const offsetY = cy - (imgRect.top + imgRect.height / 2);

    currentTranslateX -= offsetX * (visualScale / oldVisual - 1);
    currentTranslateY -= offsetY * (visualScale / oldVisual - 1);

    constrainTranslation();
    applyTransform();
    updateZoomIndicator();
    updateZoomButtons();
}

function updateResetButtonVisibility() {
    const resetBtn = document.querySelector('.zoom-btn.reset');
    if (resetBtn) {
        // æ‰‹æ©Ÿç«¯ç¸½æ˜¯é¡¯ç¤ºå›å¾©åŸç‹€æŒ‰éˆ•ï¼Œæˆ–è€…åªåœ¨éœ€è¦æ™‚é¡¯ç¤º
        if (window.innerWidth <= 768) {
            // æ‰‹æ©Ÿç«¯ï¼šåªè¦æœ‰ç¸®æ”¾æˆ–æ‹–æ›³å°±é¡¯ç¤º
            if (hasUserZoomed || isZoomed || currentTranslateX !== 0 || currentTranslateY !== 0) {
                resetBtn.style.display = 'flex';
            } else {
                resetBtn.style.display = 'none';
            }
        } else {
            // é›»è…¦ç«¯ï¼šæ™ºæ…§é¡¯ç¤º
            if (hasUserZoomed || isZoomed || currentTranslateX !== 0 || currentTranslateY !== 0) {
                resetBtn.style.display = 'flex';
            } else {
                resetBtn.style.display = 'none';
            }
        }
    }
}

    function constrainTranslation() {
        const modalImg = document.getElementById('modal-image');
        const container = document.getElementById('modalContainer');
        
        const containerRect = container.getBoundingClientRect();
        const imgRect = modalImg.getBoundingClientRect();
        
        // è¨ˆç®—åœ–ç‰‡åœ¨ç•¶å‰ç¸®æ”¾ä¸‹çš„å¯¦éš›é¡¯ç¤ºå°ºå¯¸
        const displayWidth = imgRect.width * currentScale;
        const displayHeight = imgRect.height * currentScale;
        
        // è¨ˆç®—æœ€å¤§å…è¨±çš„æ‹–æ›³ç¯„åœ
        const maxTranslateX = Math.max(0, (displayWidth - containerRect.width) / 2);
        const maxTranslateY = Math.max(0, (displayHeight - containerRect.height) / 2);
        
        // åš´æ ¼é™åˆ¶ç¯„åœ
        if (displayWidth > containerRect.width) {
            currentTranslateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, currentTranslateX));
        } else {
            currentTranslateX = 0;
        }
        
        if (displayHeight > containerRect.height) {
            currentTranslateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, currentTranslateY));
        } else {
            currentTranslateY = 0;
        }
    }

    function resetZoomImmediate() {
    const modalImg = document.getElementById('modal-image');
    isZoomed = false;
    visualScale = 1;
    currentScale = baseScale; // ä¿æŒæœ€åˆçš„æ¯”ä¾‹
    currentTranslateX = 0;
    currentTranslateY = 0;
    modalImg.style.transition = 'none'; // å–æ¶ˆå‹•ç•«
    modalImg.style.transform = 'translate(0, 0) scale(1)';
    modalImg.classList.remove('zoomed');
}

    // ä¿®æ”¹ zoomIn å’Œ zoomOut å‡½æ•¸
function zoomIn() {
    const modalImg = document.getElementById('modal-image');
    const container = document.getElementById('modalContainer');
    const rect = container.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    handleZoom(1, centerX, centerY);
}

function zoomOut() {
    const modalImg = document.getElementById('modal-image');
    const container = document.getElementById('modalContainer');
    const rect = container.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    handleZoom(-1, centerX, centerY);
}

    // ä¿®æ”¹ handleWheelZoom å‡½æ•¸ï¼Œè®“æ»¾è¼ªä¹Ÿä½¿ç”¨å›ºå®šç´šåˆ¥
function handleWheelZoom(e) {
    if (e.ctrlKey) {
        e.preventDefault();
        const direction = e.deltaY < 0 ? 1 : -1;
        handleZoom(direction, e.clientX, e.clientY);
    }
}

    // æ­£ç¢ºçš„ transform å¥—ç”¨
function applyTransform() {
  const modalImg = document.getElementById('modal-image');
  modalImg.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
}

    // æ–°å¢æ›´æ–°æŒ‰éˆ•ç‹€æ…‹çš„å‡½æ•¸
function updateZoomButtons() {
    const zoomInBtn = document.querySelector('.zoom-btn:last-child');
    const zoomOutBtn = document.querySelector('.zoom-btn:first-child');
    
    // ç¦ç”¨/å•Ÿç”¨ç¸®å°æŒ‰éˆ•
    if (currentZoomIndex === 0) {
        zoomOutBtn.disabled = true;
        zoomOutBtn.style.opacity = '0.3';
        zoomOutBtn.style.cursor = 'not-allowed';
    } else {
        zoomOutBtn.disabled = false;
        zoomOutBtn.style.opacity = '1';
        zoomOutBtn.style.cursor = 'pointer';
    }
    
    // ç¦ç”¨/å•Ÿç”¨æ”¾å¤§æŒ‰éˆ•
    if (currentZoomIndex === zoomLevels.length - 1) {
        zoomInBtn.disabled = true;
        zoomInBtn.style.opacity = '0.3';
        zoomInBtn.style.cursor = 'not-allowed';
    } else {
        zoomInBtn.disabled = false;
        zoomInBtn.style.opacity = '1';
        zoomInBtn.style.cursor = 'pointer';
    }
}

function updateZoomIndicator() {
    const indicator = document.querySelector('.zoom-indicator');
    const resetBtn = document.querySelector('.zoom-btn.reset');
    
    if (indicator && resetBtn) {
        const scaleText = Math.round(visualScale * 100) + '%';
        
        if (window.innerWidth <= 768) {
            // æ‰‹æ©Ÿç«¯é‚è¼¯
            if (visualScale === 1 && !hasUserZoomed) {
                // åˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤º"ç…§ç‰‡å¯ç¸®æ”¾"
                indicator.textContent = "ç…§ç‰‡å¯ç¸®æ”¾";
                resetBtn.textContent = "å›å¾©åŸç‹€";
            } else {
                // ç¸®æ”¾ç‹€æ…‹æˆ–ç”¨æˆ¶æ“ä½œå¾Œï¼šé¡¯ç¤ºç™¾åˆ†æ¯”
                indicator.textContent = scaleText;
                resetBtn.textContent = "å›å¾©åŸç‹€";
            }
        } else {
            // é›»è…¦ç«¯ï¼šåªé¡¯ç¤ºç™¾åˆ†æ¯”
            indicator.textContent = scaleText;
            resetBtn.textContent = "å›å¾©åŸç‹€";
        }
    }
}

    // æ”¹å–„æ‰‹æ©Ÿé›™æŒ‡ç¸®æ”¾æ”¯æ´
function setupTouchZoom(modalImg) {
    let initialDistance = 0;
    let initialScale = 1;
    let initialX = 0, initialY = 0;
    let isPinching = false;

    modalImg.addEventListener('touchstart', e => {
        if (e.touches.length === 2) {
            e.preventDefault();
            isPinching = true;
            const [t1, t2] = e.touches;
            initialDistance = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
            initialScale = currentScale;
            initialX = (t1.clientX + t2.clientX) / 2;
            initialY = (t1.clientY + t2.clientY) / 2;
        }
    }, { passive: false });

    modalImg.addEventListener('touchmove', e => {
        if (e.touches.length === 2 && initialDistance > 0) {
            e.preventDefault();
            isPinching = true;
            const [t1, t2] = e.touches;
            const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
            const factor = dist / initialDistance;
            
            // ä½¿ç”¨å›ºå®šç´šåˆ¥ç¸®æ”¾è€Œä¸æ˜¯é€£çºŒç¸®æ”¾
            const targetScale = initialScale * factor;
            const closestZoomLevel = findClosestZoomLevel(targetScale);
            
            if (closestZoomLevel !== visualScale) {
                const direction = closestZoomLevel > visualScale ? 1 : -1;
                handleZoom(direction, initialX, initialY);
            }
        }
    }, { passive: false });

    modalImg.addEventListener('touchend', (e) => {
        if (isPinching) {
            isPinching = false;
            // çŸ­æš«ç¦ç”¨æ»‘å‹•åˆ‡æ›ï¼Œé¿å…èª¤è§¸
            setTimeout(() => {
                isPinching = false;
            }, 300);
        }
        initialDistance = 0;
    });
}

// è¼”åŠ©å‡½æ•¸ï¼šæ‰¾åˆ°æœ€æ¥è¿‘çš„å›ºå®šç¸®æ”¾ç´šåˆ¥
function findClosestZoomLevel(targetScale) {
    let closestLevel = zoomLevels[0];
    let minDiff = Math.abs(targetScale - closestLevel);
    
    for (let i = 1; i < zoomLevels.length; i++) {
        const diff = Math.abs(targetScale - zoomLevels[i]);
        if (diff < minDiff) {
            minDiff = diff;
            closestLevel = zoomLevels[i];
        }
    }
    return closestLevel;
}

// ç”¨æ–¼ pinch çš„ç¸®æ”¾æ›´æ–°
function handlePinchZoom(newScale, cx, cy) {
  const modalImg = document.getElementById('modal-image');
  const container = document.getElementById('modalContainer');
  const oldVisual = visualScale;

  visualScale = Math.max(1, Math.min(2.0, newScale));
  currentScale = baseScale * visualScale;
  isZoomed = visualScale > 1.0;

  const rect = container.getBoundingClientRect();
  const imgRect = modalImg.getBoundingClientRect();
  const offsetX = cx - (imgRect.left + imgRect.width / 2);
  const offsetY = cy - (imgRect.top + imgRect.height / 2);

  currentTranslateX -= offsetX * (visualScale / oldVisual - 1);
  currentTranslateY -= offsetY * (visualScale / oldVisual - 1);

  constrainTranslation();
  applyTransform();
  updateZoomIndicator();
}

    function setupSwipeNavigation(container) {
    let startX = 0;
    let startY = 0;
    let isSwiping = false;

    container.addEventListener('touchstart', (e) => {
        if (isZoomed || e.touches.length !== 1) return;
        
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isSwiping = true;
    });

    container.addEventListener('touchmove', (e) => {
        if (!isSwiping || isZoomed || e.touches.length !== 1) return;
        
        const currentX = e.touches[0].clientX;
        const diffX = currentX - startX;
        
        // è¼•å¾®é˜»æ­¢é è¨­è¡Œç‚ºï¼Œé¿å…é é¢æ»¾å‹•
        if (Math.abs(diffX) > 10) {
            e.preventDefault();
        }
    });

    container.addEventListener('touchend', (e) => {
        if (!isSwiping || isZoomed) return;
        
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        const diffX = endX - startX;
        const diffY = endY - startY;
        
        isSwiping = false;
        
        // æ›´å¯¬é¬†çš„æ»‘å‹•æ¢ä»¶
        const minSwipeDistance = 40; // é™ä½è·é›¢è¦æ±‚
        const maxVerticalDistance = 60; // æé«˜å‚ç›´å®¹éŒ¯
        
        if (Math.abs(diffX) > minSwipeDistance && Math.abs(diffY) < maxVerticalDistance) {
            // ç¢ºä¿æ»‘å‹•æ–¹å‘æ­£ç¢º
            if (diffX > 0) {
                // å‘å³æ»‘ï¼šä¸Šä¸€å¼µ
                if (currentIndex > 0) {
                    navigatePhoto(-1);
                }
            } else {
                // å‘å·¦æ»‘ï¼šä¸‹ä¸€å¼µ
                if (currentIndex < currentPhotoUrls.length - 1) {
                    navigatePhoto(1);
                }
            }
        }
    });
}

    function navigatePhoto(direction) {
        if (direction === -1 && currentIndex <= 0) return;
        if (direction === 1 && currentIndex >= currentPhotoUrls.length - 1) return;
        
        // åˆ‡æ›ç…§ç‰‡æ™‚è‡ªå‹•é‡ç½®ç¸®æ”¾
        resetZoom();
        
        currentIndex += direction;
        const modalImg = document.getElementById('modal-image');
        modalImg.src = currentPhotoUrls[currentIndex];
        
        updateModalNavButtons();
    }

    function updateModalNavButtons() {
        const leftBtn = document.querySelector('.nav-btn:nth-child(1)');
        const rightBtn = document.querySelector('.nav-btn:nth-child(2)');
        
        const isFirst = currentIndex === 0;
        const isLast = currentIndex === currentPhotoUrls.length - 1;
        
        if (isFirst) {
            leftBtn.style.opacity = "0.3";
            leftBtn.style.cursor = "not-allowed";
            leftBtn.style.pointerEvents = "none";
        } else {
            leftBtn.style.opacity = "1";
            leftBtn.style.cursor = "pointer";
            leftBtn.style.pointerEvents = "auto";
        }
        
        if (isLast) {
            rightBtn.style.opacity = "0.3";
            rightBtn.style.cursor = "not-allowed";
            rightBtn.style.pointerEvents = "none";
        } else {
            rightBtn.style.opacity = "1";
            rightBtn.style.cursor = "pointer";
            rightBtn.style.pointerEvents = "auto";
        }
    }

    function closeModal() {
        document.getElementById('image-modal').style.display = 'none';
        resetZoom();
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelector('.nav-btn:nth-child(1)').onclick = function() { navigatePhoto(-1); };
        document.querySelector('.nav-btn:nth-child(2)').onclick = function() { navigatePhoto(1); };
    });

    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('image-modal');
        if (modal.style.display === 'block' && !isKeyboardCooldown) {
            if (e.key === 'ArrowLeft') {
                navigatePhoto(-1);
                setKeyboardCooldown();
            } else if (e.key === 'ArrowRight') {
                navigatePhoto(1);
                setKeyboardCooldown();
            } else if (e.key === 'Escape') {
                closeModal();
            }
        }
    });

    function setKeyboardCooldown() {
        isKeyboardCooldown = true;
        setTimeout(() => {
            isKeyboardCooldown = false;
        }, keyboardCooldownTime);
    }

    function enableDragForZoomedImage(img) {
        const container = document.getElementById('modalContainer');
        
        img.addEventListener('mousedown', (e) => {
            if (!isZoomed) return;
            isDragging = true;
            dragStartX = e.clientX - currentTranslateX;
            dragStartY = e.clientY - currentTranslateY;
            img.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging || !isZoomed) return;
            
            currentTranslateX = e.clientX - dragStartX;
            currentTranslateY = e.clientY - dragStartY;
            
            constrainTranslation();
            applyTransform();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            if (isZoomed) {
                img.style.cursor = 'grab';
            }
        });

        // æ‰‹æ©Ÿè§¸æ§æ‹–å‹•
        let touchStart = null;
        img.addEventListener('touchstart', (e) => {
            if (isZoomed && e.touches.length === 1) {
                touchStart = { 
                    x: e.touches[0].clientX, 
                    y: e.touches[0].clientY,
                    translateX: currentTranslateX,
                    translateY: currentTranslateY
                };
                e.preventDefault();
            }
        });

        img.addEventListener('touchmove', (e) => {
            if (isZoomed && e.touches.length === 1 && touchStart) {
                const dx = e.touches[0].clientX - touchStart.x;
                const dy = e.touches[0].clientY - touchStart.y;
                
                currentTranslateX = touchStart.translateX + dx;
                currentTranslateY = touchStart.translateY + dy;
                
                constrainTranslation();
                applyTransform();
                e.preventDefault();
            }
        });

        img.addEventListener('touchend', () => {
            touchStart = null;
        });
    }

    let playbackAudio, rafId;

    function initCustomPlayer(url) {
      playbackAudio = new Audio(url);
      playbackAudio.preload = 'auto';
      playbackAudio.load();

      const btn = document.getElementById('playBtn');
      const label = document.getElementById('timeLabel');
      const bar = document.getElementById('waveFill');
      const progressBar = document.getElementById('progressBar');
      let playing = false;
      let isDragging = false;

      progressBar.addEventListener('mousedown', startDrag);
      progressBar.addEventListener('touchstart', startDrag);
      
      function startDrag(e) {
        isDragging = true;
        updateProgressOnDrag(e);
        
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
        
        e.preventDefault();
      }
      
      function onDrag(e) {
        if (!isDragging) return;
        updateProgressOnDrag(e);
      }
      
      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
        
        if (playing) {
          playbackAudio.play();
        }
      }
      
      function updateProgressOnDrag(e) {
        if (!playbackAudio.duration) return;
        
        const rect = progressBar.getBoundingClientRect();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        let percent = (clientX - rect.left) / rect.width;
        percent = Math.max(0, Math.min(1, percent));
        
        const newTime = percent * playbackAudio.duration;
        playbackAudio.currentTime = newTime;
        updateProgress();
        
        if (playing && isDragging) {
          playbackAudio.pause();
        }
      }

      progressBar.onclick = (e) => {
        if (!playbackAudio.duration) return;
        
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        const newTime = percent * playbackAudio.duration;
        
        playbackAudio.currentTime = newTime;
        updateProgress();
        
        if (!playing) {
          playbackAudio.play().then(() => {
            setPauseIcon();
            playing = true;
            updateProgress();
          });
        }
      };

      btn.onclick = async () => {
        if (!playing) {
          await playbackAudio.play();
          setPauseIcon();
          playing = true;
          updateProgress();
        } else {
          playbackAudio.pause();
          setPlayIcon();
          playing = false;
          cancelAnimationFrame(rafId);
        }
      };

      playbackAudio.onended = () => {
        setPlayIcon();
        playing = false;
        cancelAnimationFrame(rafId);
        bar.style.width = '100%';
      };

      function updateProgress() {
        if (!playing && !isDragging) return;
        const dur = playbackAudio.duration || 0;
        const cur = playbackAudio.currentTime || 0;
        if (dur > 0) {
          const pct = Math.min(100, (cur / dur) * 100);
          bar.style.width = pct + '%';
          const min = Math.floor(cur / 60);
          const sec = Math.floor(cur % 60).toString().padStart(2, '0');
          label.textContent = `${min}:${sec}`;
        }
        if (playing || isDragging) {
          rafId = requestAnimationFrame(updateProgress);
        }
      }

      function setPauseIcon() {
        btn.innerHTML = `<div style="
          width:14px;height:16px;background:#fff;
          clip-path: polygon(
            0 0,0 100%,35% 100%,35% 0,65% 0,65% 100%,100% 100%,100% 0
          );
        "></div>`;
      }

      function setPlayIcon() {
        btn.innerHTML = `<div style="
          width:0;height:0;border-top:9px solid transparent;
          border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;
        "></div>`;
      }
    }

    function closePage() {
      if (document.referrer && document.referrer.includes(location.hostname)) {
        history.back();
      } else {
        window.close();
        setTimeout(() => {
          location.href = 'https://report-tan-tau.vercel.app/';
        }, 100);
      }
    }

    // èªéŸ³è½‰æ–‡å­—ç·¨è¼¯åŠŸèƒ½
let originalTranscription = '';

async function loadTranscriptionFromFirebase(reportId) {
    try {
        const { ref, getDownloadURL } = window.firebaseStorage;
        const tRef = ref(window.firebaseStorage.storage, `reports/${reportId}/transcription.txt`);
        const url = await getDownloadURL(tRef);
        const text = await (await fetch(url)).text();
        
        document.getElementById('transcription-section').style.display = 'block';
        const transcriptionElement = document.getElementById('transcription-text');
        transcriptionElement.textContent = text;
        originalTranscription = text;
        
        // è¨­å®šç·¨è¼¯åŠŸèƒ½
        transcriptionElement.setAttribute('contenteditable', 'true');
        
        document.getElementById('transcription-download').href = url;
        document.getElementById('transcription-download').download = `transcription_${reportId}.txt`;
        
        // ç¶å®šå„²å­˜å’Œé‡ç½®æŒ‰éˆ•
        setupTranscriptionEditing(reportId);
    } catch (e) {
        console.log('ç„¡èªéŸ³è½‰æ–‡å­—æª”æ¡ˆ');
    }
}

function setupTranscriptionEditing(reportId) {
    const saveBtn = document.getElementById('save-transcription');
    const resetBtn = document.getElementById('reset-transcription');
    const transcriptionElement = document.getElementById('transcription-text');
    
    saveBtn.addEventListener('click', async () => {
        const newText = transcriptionElement.textContent;
        await saveTranscriptionToServer(reportId, newText);
    });
    
    resetBtn.addEventListener('click', () => {
        transcriptionElement.textContent = originalTranscription;
        alert('å·²æ¢å¾©åŸå§‹å…§å®¹');
    });
}

async function saveTranscriptionToServer(reportId, newText) {
    try {
        // é€™è£¡éœ€è¦å¯¦ç¾å°‡ä¿®æ”¹å¾Œçš„æ–‡å­—å„²å­˜å› Excel çš„é‚è¼¯
        // æš«æ™‚ä½¿ç”¨ alert æç¤º
        alert('ä¿®æ”¹å·²å„²å­˜ï¼\n\nï¼ˆæ­¤åŠŸèƒ½éœ€è¦å¾Œç«¯ API æ”¯æ´å›å­˜åˆ° Excelï¼‰');
        console.log('å„²å­˜èªéŸ³è½‰æ–‡å­—:', { reportId, newText });
        
        // æ›´æ–°åŸå§‹å…§å®¹
        originalTranscription = newText;
    } catch (error) {
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        console.error('å„²å­˜éŒ¯èª¤:', error);
    }
}

// åŒæ­¥ç·¨è¼¯åŠŸèƒ½
function setupSyncEditing() {
    const summaryField = document.getElementById('transcription-summary-text');
    const detailField = document.getElementById('transcription-text');
    
    if (summaryField && detailField) {
        // ä¸Šæ–¹æ¬„ä½ç·¨è¼¯æ™‚åŒæ­¥åˆ°ä¸‹æ–¹
        summaryField.addEventListener('input', function() {
            detailField.textContent = this.textContent;
        });
        
        // ä¸‹æ–¹æ¬„ä½ç·¨è¼¯æ™‚åŒæ­¥åˆ°ä¸Šæ–¹
        detailField.addEventListener('input', function() {
            summaryField.textContent = this.textContent;
        });
    }
}

// åœ¨ loadTranscriptionFromFirebase å‡½æ•¸ä¸­å‘¼å«åŒæ­¥è¨­å®š
async function loadTranscriptionFromFirebase(reportId) {
    try {
        const { ref, getDownloadURL } = window.firebaseStorage;
        const tRef = ref(window.firebaseStorage.storage, `reports/${reportId}/transcription.txt`);
        const url = await getDownloadURL(tRef);
        const text = await (await fetch(url)).text();
        
        document.getElementById('transcription-section').style.display = 'block';
        const transcriptionElement = document.getElementById('transcription-text');
        transcriptionElement.textContent = text;
        originalTranscription = text;
        
        // è¨­å®šç·¨è¼¯åŠŸèƒ½
        transcriptionElement.setAttribute('contenteditable', 'true');
        
        document.getElementById('transcription-download').href = url;
        document.getElementById('transcription-download').download = `transcription_${reportId}.txt`;
        
        // ç¶å®šå„²å­˜å’Œé‡ç½®æŒ‰éˆ•
        setupTranscriptionEditing(reportId);
        
        // è¨­å®šåŒæ­¥ç·¨è¼¯
        setupSyncEditing();
        
    } catch (e) {
        console.log('ç„¡èªéŸ³è½‰æ–‡å­—æª”æ¡ˆ');
    }
}
  </script>
</body>
</html>