<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é˜²æ±›é€šå ±ç³»çµ±</title>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getStorage, ref, list, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
  authDomain: "reportsystem-c5fc7.firebaseapp.com",
  projectId: "reportsystem-c5fc7",
  storageBucket: "reportsystem-c5fc7.firebasestorage.app",
  messagingSenderId: "845064058181",
  appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
  measurementId: "G-EDQM0LWQWH"
};

const app = initializeApp(firebaseConfig);
const storage = getStorage(app);

// âœ… æŠŠ list ä¸€èµ·æ”¾é€² windowï¼Œå¤–é¢å°±èƒ½ç›´æ¥ç”¨
window.firebaseStorage = { storage, ref, list, listAll, getDownloadURL };
</script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
    .header p {
        font-size: 18px;
        margin: 8px 0;
    }
    .back-btn { background: #4285f4; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
    .report-info p {
        margin: 8px 0;
        font-size: 20px;
    }
    .photo-gallery { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 25px; 
    }

    .photo-item { 
      border-radius: 8px; 
      overflow: hidden; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
      cursor: pointer; 
      aspect-ratio: 1;
      background-color: #f5f5f5;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .photo-item img { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      display: block;
      transition: transform 0.3s ease;
    }

    .photo-item:hover img {
      transform: scale(1.05);
    }
    
    .audio-player h3 {
        font-size: 24px;
    }
    .transcription-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #ddd; }
    .transcription-text { background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; white-space: pre-wrap; line-height: 1.5; max-height: 300px; overflow-y: auto; }
    .download-link { display: inline-block; margin-top: 10px; color: #4285f4; text-decoration: none; font-weight: bold; }
    .download-link:hover { text-decoration: underline; }
    .error { text-align: center; color: #d32f2f; font-size: 18px; padding: 40px; }
    
    /* æ¨¡æ€æ¡†æ ·å¼ - ä¿®å¤ç…§ç‰‡å±…ä¸­é—®é¢˜ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      overflow: hidden;
      justify-content: center;
      align-items: center;
    }

    .modal-content-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    }

    .modal-content {
      display: block;
      max-width: 90vw;
      max-height: 80vh;
      object-fit: contain;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    /* ç”µè„‘ç‰ˆ hover æç¤º */
    @media (min-width: 769px) {
        .modal-content:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }
    }
    
    .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
    }
    
    .navigation {
        position: absolute;
        top: 50%;
        width: 100%;
        display: flex;
        justify-content: space-between;
        transform: translateY(-50%);
        pointer-events: none;
    }
    
    .nav-btn {
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 20px 15px;
        font-size: 24px;
        cursor: pointer;
        pointer-events: auto;
        margin: 0 10px;
        border-radius: 5px;
    }
    
    /* æ‰‹æœºè§¦æ§æ»‘åŠ¨ */
    @media (max-width: 768px) {
        .modal-content {
            max-width: 95vw;
            max-height: 80vh;
        }
        .nav-btn {
            padding: 15px 10px;
            font-size: 20px;
            margin: 0 5px;
        }
    }
    
    /* åŠ è½½ä¸­æ ·å¼ */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #666;
        grid-column: 1 / -1;
    }
    
    .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #ccc;
        border-top: 3px solid #0b5ed7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin { 
        from { transform: rotate(0deg); } 
        to { transform: rotate(360deg); } 
    }
    
    /* è¿›åº¦æ¡å¯æ‹–æ›³æ ·å¼ */
    .progress-bar {
        flex: 1;
        height: 12px;
        background: #eee;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        max-width: 400px;
    }
    
    .progress-bar:hover {
        background: #e0e0e0;
    }
    
    .progress-fill {
        width: 0%;
        height: 100%;
        background: #0b5ed7;
        transition: width 0.1s ease;
    }
    
    .page-close-btn {
      color: #666;
      font-size: 36px;
      font-weight: bold;
      cursor: pointer;
      z-index: 999;
      transition: all 0.3s ease;
      background: none;
      border: none;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ç”µè„‘ç‰ˆï¼šè·Ÿéšæ˜¾ç¤º */
    @media (min-width: 769px) {
      .page-close-btn {
        position: sticky;
        top: 25px;
        float: right;
        margin-right: 20px;
        margin-bottom: -40px;
      }
    }

    /* æ‰‹æœºç‰ˆï¼šå›ºå®šåœ¨å³ä¸Šè§’ */
    @media (max-width: 768px) {
      .page-close-btn {
        position: fixed;
        top: 25px;
        right: 25px;
      }
    }

    .page-close-btn:hover {
      transform: scale(1.2);
      color: #333;
    }

    .image-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: #666;
        z-index: 1;
    }

    .loading-text {
        font-size: 18px;
    }
    
    /* ç…§ç‰‡åŠ è½½ä¼˜åŒ– */
    .photo-item.loading img {
      opacity: 0;
    }
    
    .photo-item.loaded img {
      opacity: 1;
    }

    /* æ¨¡æ€æ¡†æ»‘åŠ¨åŠ¨ç”» */
    .slide-left {
      animation: slideLeft 0.3s ease;
    }
    
    .slide-right {
      animation: slideRight 0.3s ease;
    }
    
    @keyframes slideLeft {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideRight {
      from { transform: translateX(-100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ç”µè„‘ç‰ˆä¼šè·Ÿéšæ»šåŠ¨ï¼Œæ‰‹æœºç‰ˆå›ºå®šåœ¨å³ä¸Šè§’ -->
    <div class="page-close-btn" onclick="closePage()">&times;</div>

    <button class="back-btn" id="backButton" onclick="handleBack()" style="display: none;">â† è¼‰å…¥ä¸­...</button>

    <div class="header">
        <h1>é€šå ±è©³ç´°ç´€éŒ„</h1>
        <p id="report-date">å›å ±æ™‚é–“ï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div class="report-info">
        <p id="report-type">é€šå ±é¡å‹ï¼šè¼‰å…¥ä¸­...</p>
        <p id="report-status">ç‹€æ…‹ï¼šè¼‰å…¥ä¸­...</p>
        <p id="abnormal-type" style="display:none;">ç•°å¸¸åˆ†é¡ï¼šè¼‰å…¥ä¸­...</p>
        <p id="remarks">èªªæ˜ï¼šè¼‰å…¥ä¸­...</p>
        <p id="transcription-summary" style="display:none;">èªéŸ³è½‰æ–‡å­—ï¼šè¼‰å…¥ä¸­...</p>
        <p id="reporter">å›å ±è€…ï¼šè¼‰å…¥ä¸­...</p>
        <p id="companions">åŒè¡Œè€…ï¼šè¼‰å…¥ä¸­...</p>
        <p id="team">æ‰€å±¬å¤§éšŠï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div id="photo-section">
      <h2>ç…§ç‰‡</h2>
      <div id="photo-gallery" class="photo-gallery">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <span class="loading-text">ç…§ç‰‡è¼‰å…¥ä¸­...</span>
        </div>
      </div>
    </div>

    <div id="audio-section" style="display:none;">
      <div class="audio-player">
        <h3>èªéŸ³</h3>
        <div style="display:flex;align-items:center;gap:14px;margin:20px 0;max-width:500px;">
          <button id="playBtn" style="
            width:56px;height:56px;border-radius:50%;
            border:none;background:#0b5ed7;color:#fff;
            cursor:pointer;display:flex;align-items:center;justify-content:center;">
            <div id="playIcon" style="
              width:0;height:0;border-top:9px solid transparent;
              border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;">
            </div>
          </button>

          <span id="timeLabel" style="font-size:19px;color:#333;min-width:45px;">0:00</span>

          <div style="flex:1;height:12px;background:#eee;border-radius:8px;overflow:hidden;cursor:pointer;" id="progressBar">
            <div id="waveFill" style="width:0%;height:100%;background:#0b5ed7;"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="transcription-section" class="transcription-section" style="display:none;">
      <h3>ğŸ—£ï¸ èªéŸ³è½‰æ–‡å­—çµæœ</h3>
      <div id="transcription-text" class="transcription-text"></div>
      <a id="transcription-download" href="#" class="download-link">ğŸ“¥ ä¸‹è¼‰æ–‡å­—æª”</a>
    </div>

    <div id="image-modal" class="modal">
      <span class="close" onclick="closeModal()">&times;</span>
      <div class="modal-content-container">
        <img class="modal-content" id="modal-image">
      </div>
      <div class="navigation">
        <button class="nav-btn" onclick="navigatePhoto(-1)">&#10094;</button>
        <button class="nav-btn" onclick="navigatePhoto(1)">&#10095;</button>
      </div>
    </div>
  </div>

  <script>
    let currentIndex = 0, currentPhotoUrls = [], currentReportId = '', pageSource = '';
    let photoItems = []; // å­˜å‚¨ç…§ç‰‡é¡¹ç›®ä¿¡æ¯

    document.addEventListener('DOMContentLoaded', () => {
      // å…ˆè¯» LocalStorage æš‚å­˜èµ„æ–™
      const temp = localStorage.getItem('tempReportData');
      if (temp) {
        try {
          const data = JSON.parse(temp);
          console.log('âš¡ æ˜¾ç¤ºæš‚å­˜èµ„æ–™:', data);
          handleResponse(data); // ç›´æ¥ç”¨ç°æœ‰ handleResponse å¡«å…¥èµ„æ–™
        } catch (e) {
          console.warn('æš‚å­˜èµ„æ–™è§£æå¤±è´¥:', e);
        }
        localStorage.removeItem('tempReportData'); // ç”¨å®Œæ¸…é™¤
      }

      // === åŸæœ¬çš„æµç¨‹ç»§ç»­æ‰§è¡Œ ===
      const urlParams = new URLSearchParams(window.location.search);
      const reportId = urlParams.get('id');
      pageSource = urlParams.get('source');
      if (reportId) {
        currentReportId = reportId;
        setupBackButton();
        loadReportData(reportId); // å‡ ç§’åè‡ªåŠ¨æŠ“æ­£å¼èµ„æ–™
      } else showError('é”™è¯¯ï¼šæœªæä¾›æŠ¥å‘ŠID');
    });

    function setupBackButton() {
      const btn = document.getElementById('backButton');
      btn.style.display = 'block';
      btn.innerHTML = pageSource === 'form' ? 'â† è¿”å›è¡¨å•' : 'â† è¿”å›';
    }

    function handleBack() {
      const btn = document.getElementById('backButton');
      btn.innerHTML = 'â† è¿”å›ä¸­...';
      btn.disabled = true;
      if (pageSource === 'form') location.href = 'https://report-tan-tau.vercel.app/';
      else if (document.referrer && document.referrer.includes(location.hostname)) history.back();
      else location.href = 'https://report-tan-tau.vercel.app/';
    }

    async function loadReportData(reportId) {
      try {
        document.getElementById('report-date').innerHTML = `å›å ±æ™‚é–“ï¼š${formatDateFromId(reportId)}`;
        await loadReportInfoFromSheet(reportId);
        await loadPhotosFromFirebase(reportId);
        await loadAudioFromFirebase(reportId);
        await loadTranscriptionFromFirebase(reportId);
      } catch (e) {
        console.error(e);
        showError('è¼‰å…¥æ•¸æ“šå¤±æ•—');
      }
    }

    function handleResponse(data) {
      console.log('ğŸ“¥ JSONP å–å¾—:', data);
      if (!data || data.error) return showError('æŸ¥ç„¡æ­¤å ±å‘Šè³‡æ–™');

      // ç§»é™¤ç°è‰²ï¼Œæ”¹å›æ­£å¸¸é¢œè‰²
      const elements = ['report-type', 'report-status', 'abnormal-type', 'remarks', 
                       'transcription-summary', 'reporter', 'companions', 'team'];
      elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.color = '';
      });

      document.getElementById('report-type').innerHTML = `é€šå ±é¡å‹ï¼š${data['é€šå ±é¡å‹'] || 'ç„¡'}`;
      document.getElementById('report-status').innerHTML = `ç‹€æ…‹ï¼š${data['ç‹€æ…‹'] || 'ç„¡'}`;

      if (data['ç‹€æ…‹'] === 'ç•°å¸¸') {
        document.getElementById('abnormal-type').style.display = 'block';
        document.getElementById('abnormal-type').innerHTML = `ç•°å¸¸åˆ†é¡ï¼š${data['ç•°å¸¸åˆ†é¡'] || 'ç„¡'}`;
        document.getElementById('transcription-summary').style.display = 'block';
        document.getElementById('transcription-summary').innerHTML = `èªéŸ³è½‰æ–‡å­—ï¼š${data['èªéŸ³è½‰æ–‡å­—'] || 'ç„¡'}`;
      } else {
        document.getElementById('abnormal-type').style.display = 'none';
        document.getElementById('transcription-summary').style.display = 'none';
      }

      document.getElementById('remarks').innerHTML = `èªªæ˜ï¼š${data['èªªæ˜'] || 'ç„¡'}`;
      document.getElementById('reporter').innerHTML = `å›å ±è€…ï¼š${data['å›å ±è€…'] || 'ç„¡'}`;
      document.getElementById('companions').innerHTML = `åŒè¡Œè€…ï¼š${data['åŒè¡Œè€…'] || 'ç„¡'}`;
      document.getElementById('team').innerHTML = `æ‰€å±¬å¤§éšŠï¼š${data['æ‰€å±¬å¤§éšŠ'] || 'ç„¡'}`;
    }

    async function loadReportInfoFromSheet(reportId) {
      const url = `https://script.google.com/macros/s/AKfycby1hGsemrBwyFJvDRV5qcooS0t5qOoODHqU_9Rk9HvFBsP39Uzd2rtBqPFjj3S0_CyILg/exec?id=${reportId}&callback=handleResponse`;
      const script = document.createElement('script');
      script.src = url;
      document.body.appendChild(script);
    }

    function formatDateFromId(reportId) {
      const t = parseInt(reportId.replace('report_', ''));
      return isNaN(t) ? 'æœªçŸ¥æ™‚é–“' : new Date(t).toLocaleString('zh-TW');
    }

async function loadPhotosFromFirebase(reportId) {
  try {
    const { ref, list, getDownloadURL } = window.firebaseStorage;
    const storageRef = ref(window.firebaseStorage.storage, `reports/${reportId}/`);
    let pageToken = null;
    let allUrls = [];

    do {
      const result = await list(storageRef, { maxResults: 50, pageToken });
      const validItems = result.items.filter(f => f.name && /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name)); // âœ… åªç•™åœ–ç‰‡
      const urls = await Promise.all(validItems.map(f => getDownloadURL(f).catch(() => null)));
      allUrls = allUrls.concat(urls.filter(u => !!u)); // âœ… æ¿¾æ‰ null æˆ–ç©º
      pageToken = result.nextPageToken;
    } while (pageToken);

    if (!allUrls.length) {
      document.getElementById('photo-gallery').innerHTML =
        '<p style="text-align:center;color:#666;font-size:18px;">æ­¤å›å ±æ²’æœ‰ç…§ç‰‡</p>';
      return;
    }

    setupLazyGallery(allUrls);
  } catch (e) {
    console.error("âŒ è¼‰å…¥ç…§ç‰‡éŒ¯èª¤:", e);
    document.getElementById('photo-gallery').innerHTML =
      '<p style="color:#666;text-align:center;font-size:18px;">è¼‰å…¥ç…§ç‰‡å¤±æ•—</p>';
  }
}

function setupLazyGallery(allUrls) {
  const gallery = document.getElementById('photo-gallery');
  gallery.innerHTML = '';

  let loadedCount = 0;
  const batchSize = 10;
  let isLoading = false;
  let allLoaded = false;

  function renderBatch() {
    if (isLoading || allLoaded) return;
    isLoading = true;

    const remaining = allUrls.length - loadedCount;
    if (remaining <= 0) {
      allLoaded = true;
      isLoading = false;
      window.removeEventListener('scroll', onScroll);
      return;
    }

    // âœ… åŠ é€™è£¡ï¼šæ¿¾æ‰ç©º URL æˆ–å£æ‰çš„
    const nextBatch = allUrls
      .slice(loadedCount, loadedCount + Math.min(batchSize, remaining))
      .filter(u => typeof u === 'string' && u.startsWith('https'));

    nextBatch.forEach((url, i) => {
      const div = document.createElement('div');
      div.className = 'photo-item';

      const img = new Image();
      img.loading = "lazy";
      img.decoding = "async";
      img.src = url;
      img.alt = `ç…§ç‰‡ ${loadedCount + i + 1}`;
      img.onerror = () => {
        div.innerHTML = '<span style="color:#999;">âŒ è¼‰å…¥å¤±æ•—</span>';
      };

      div.appendChild(img);
      div.onclick = () => openModal(loadedCount + i, allUrls);
      gallery.appendChild(div);
    });

    loadedCount += nextBatch.length;
    if (loadedCount >= allUrls.length) {
      allLoaded = true;
      window.removeEventListener('scroll', onScroll);
    }
    isLoading = false;
  }

  renderBatch();

  function onScroll() {
    if (allLoaded || isLoading) return;
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
      renderBatch();
    }
  }

  window.addEventListener('scroll', onScroll);
}

    async function loadAudioFromFirebase(reportId) {
      const { ref, getDownloadURL } = window.firebaseStorage;
      const exts = ['.webm', '.mp3', '.wav', '.m4a'];

      for (const ext of exts) {
        try {
          const r = ref(window.firebaseStorage.storage, `reports/${reportId}/recording${ext}`);
          const url = await getDownloadURL(r);

          document.getElementById('audio-section').style.display = 'block';
          initCustomPlayer(url);
          console.log('ğŸ§ è¼‰å…¥éŸ³è¨Š:', url);
          break;
        } catch {}
      }
    }

    async function loadTranscriptionFromFirebase(reportId) {
      try {
        const { ref, getDownloadURL } = window.firebaseStorage;
        const tRef = ref(window.firebaseStorage.storage, `reports/${reportId}/transcription.txt`);
        const url = await getDownloadURL(tRef);
        const text = await (await fetch(url)).text();
        document.getElementById('transcription-section').style.display = 'block';
        document.getElementById('transcription-text').textContent = text;
        document.getElementById('transcription-download').href = url;
        document.getElementById('transcription-download').download = `transcription_${reportId}.txt`;
      } catch {}
    }

    function showError(msg) {
      document.getElementById('photo-gallery').innerHTML = `<div class="error">${msg}</div>`;
    }

    function displayPhotos(urls) {
      const g = document.getElementById('photo-gallery');
      
      // æ¸…é™¤æ‰€æœ‰å†…å®¹
      g.innerHTML = '';
      
      // å¦‚æœæ²¡æœ‰ç…§ç‰‡
      if (!urls || urls.length === 0) {
          g.innerHTML = '<p style="text-align:center;color:#666;font-size:18px;grid-column:1/-1;">æ­¤å›å ±æ²’æœ‰ç…§ç‰‡</p>';
          return;
      }
      
      // ç›´æ¥åˆ›å»ºç…§ç‰‡å…ƒç´ ï¼Œä¸æ˜¾ç¤ºåŠ è½½ä¸­æç¤º
      urls.forEach((u, i) => {
          const d = document.createElement('div');
          d.className = 'photo-item loading';
          
          const img = new Image();
          img.loading = "lazy"; // âœ… ç€è¦½å™¨å»¶é²è¼‰å…¥åœ–ç‰‡
img.decoding = "async"; // âœ… æé«˜è¼‰å…¥ç©©å®šåº¦
          
          // å…ˆè®¾å®šå›ºå®šå°ºå¯¸é¿å…å‹æ‰
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.backgroundColor = '#f5f5f5';
          img.style.transition = 'opacity 0.3s ease';
          
          // å›¾ç‰‡åŠ è½½å®Œæˆåæ˜¾ç¤º
          img.onload = function() {
              d.classList.remove('loading');
              d.classList.add('loaded');
          };
          
          // è®¾å®šå›¾ç‰‡æº
          img.src = u;
          img.alt = `ç…§ç‰‡ ${i + 1}`;
          
          d.appendChild(img);
          d.onclick = () => openModal(i, urls);
          g.appendChild(d);
      });
    }

    function openModal(i, urls) {
      currentIndex = i; 
      currentPhotoUrls = urls;
      const m = document.getElementById('image-modal');
      const modalImg = document.getElementById('modal-image');
      
      // ä¿®å¤2: é‡ç½®æ‰€æœ‰æ ·å¼
      modalImg.className = 'modal-content';
      modalImg.style.opacity = '1';
      
      modalImg.src = urls[i];
      m.style.display = 'flex'; // ä½¿ç”¨ flex ç¡®ä¿å±…ä¸­
      
      let startX = 0;
      let isSwiping = false;
      let swipeThreshold = 50; // æ»‘åŠ¨é˜ˆå€¼
      
      // ç”µè„‘ç‰ˆç‚¹å‡»åˆ‡æ¢
      modalImg.onclick = function(e) {
          if (window.innerWidth > 768) {
              const rect = this.getBoundingClientRect();
              const clickX = e.clientX - rect.left;
              const width = rect.width;
              
              if (clickX < width / 2) {
                  navigatePhoto(-1);
              } else {
                  navigatePhoto(1);
              }
          }
      };
      
      // ä¿®å¤3: æ”¹è¿›æ‰‹æœºæ»‘åŠ¨åŠŸèƒ½
      modalImg.addEventListener('touchstart', function(e) {
          startX = e.touches[0].clientX;
          isSwiping = true;
          this.style.transition = 'none'; // æ»‘åŠ¨æ—¶ç¦ç”¨è¿‡æ¸¡
      });
      
      modalImg.addEventListener('touchmove', function(e) {
          if (!isSwiping) return;
          e.preventDefault();
          
          const currentX = e.touches[0].clientX;
          const diffX = currentX - startX;
          
          // æ·»åŠ æ»‘åŠ¨åé¦ˆ
          this.style.transform = `translateX(${diffX}px)`;
      });
      
      modalImg.addEventListener('touchend', function(e) {
          if (!isSwiping) return;
          isSwiping = false;
          
          const endX = e.changedTouches[0].clientX;
          const diffX = endX - startX;
          
          // é‡ç½®å›¾ç‰‡ä½ç½®
          this.style.transform = 'translateX(0)';
          this.style.transition = 'transform 0.3s ease';
          
          // ä¿®å¤4: æ”¹è¿›æ»‘åŠ¨åˆ¤æ–­é€»è¾‘
          if (Math.abs(diffX) > swipeThreshold) {
              if (diffX > 0) {
                  navigatePhoto(-1); // å‘å³æ»‘ â†’ ä¸Šä¸€å¼ 
              } else {
                  navigatePhoto(1); // å‘å·¦æ»‘ â†’ ä¸‹ä¸€å¼ 
              }
          }
          
          // é‡ç½®è¿‡æ¸¡
          setTimeout(() => {
              this.style.transition = 'none';
          }, 300);
      });
    }

    function navigatePhoto(direction) {
        // ä¿®å¤5: æ·»åŠ è¾¹ç•Œæ£€æŸ¥ï¼Œé˜²æ­¢è¶Šç•Œ
        if (direction === -1 && currentIndex <= 0) return;
        if (direction === 1 && currentIndex >= currentPhotoUrls.length - 1) return;
        
        const modalImg = document.getElementById('modal-image');
        
        // ä¿®å¤6: æ·»åŠ æ»‘åŠ¨åŠ¨ç”»
        if (direction === -1) {
            modalImg.classList.add('slide-right');
        } else {
            modalImg.classList.add('slide-left');
        }
        
        // çŸ­æš‚å»¶è¿Ÿååˆ‡æ¢å›¾ç‰‡
        setTimeout(() => {
            if (direction === -1) {
                currentIndex--;
            } else {
                currentIndex++;
            }
            
            modalImg.src = currentPhotoUrls[currentIndex];
            
            // ç§»é™¤åŠ¨ç”»ç±»ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡åŠ¨ç”»
            setTimeout(() => {
                modalImg.classList.remove('slide-left', 'slide-right');
            }, 300);
        }, 150);
    }

    // ç¡®ä¿å…³é—­æŒ‰é’®å’Œå¯¼èˆªæŒ‰é’®æ­£å¸¸å·¥ä½œ
    function closeModal() { 
      document.getElementById('image-modal').style.display = 'none'; 
    }

    // ä¿®å¤7: æ­£ç¡®ç»‘å®šå¯¼èˆªæŒ‰é’®äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelector('.nav-btn:nth-child(1)').onclick = function() { navigatePhoto(-1); };
      document.querySelector('.nav-btn:nth-child(2)').onclick = function() { navigatePhoto(1); };
    });

    // é”®ç›˜äº‹ä»¶
    document.addEventListener('keydown', function(e) {
      const modal = document.getElementById('image-modal');
      if (modal.style.display === 'flex') {
        if (e.key === 'ArrowLeft') {
          navigatePhoto(-1);
        } else if (e.key === 'ArrowRight') {
          navigatePhoto(1);
        } else if (e.key === 'Escape') {
          closeModal();
        }
      }
    });

    let playbackAudio, rafId;

    function initCustomPlayer(url) {
      playbackAudio = new Audio(url);
      playbackAudio.preload = 'auto';
      playbackAudio.load();

      const btn = document.getElementById('playBtn');
      const label = document.getElementById('timeLabel');
      const bar = document.getElementById('waveFill');
      const progressBar = document.getElementById('progressBar');
      let playing = false;
      let isDragging = false;

      // æ‹–æ›³åŠŸèƒ½
      progressBar.addEventListener('mousedown', startDrag);
      progressBar.addEventListener('touchstart', startDrag);
      
      function startDrag(e) {
        isDragging = true;
        updateProgressOnDrag(e);
        
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
        
        e.preventDefault();
      }
      
      function onDrag(e) {
        if (!isDragging) return;
        updateProgressOnDrag(e);
      }
      
      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
        
        // å¦‚æœåŸæœ¬åœ¨æ’­æ”¾ï¼Œæ‹–æ›³ç»“æŸåç»§ç»­æ’­æ”¾
        if (playing) {
          playbackAudio.play();
        }
      }
      
      function updateProgressOnDrag(e) {
        if (!playbackAudio.duration) return;
        
        const rect = progressBar.getBoundingClientRect();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        let percent = (clientX - rect.left) / rect.width;
        percent = Math.max(0, Math.min(1, percent)); // é™åˆ¶åœ¨ 0-1 èŒƒå›´
        
        const newTime = percent * playbackAudio.duration;
        playbackAudio.currentTime = newTime;
        updateProgress();
        
        // æ‹–æ›³æ—¶æš‚åœæ’­æ”¾
        if (playing && isDragging) {
          playbackAudio.pause();
        }
      }

      // ç‚¹å‡»åŠŸèƒ½ï¼ˆä¿ç•™ï¼‰
      progressBar.onclick = (e) => {
        if (!playbackAudio.duration) return;
        
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        const newTime = percent * playbackAudio.duration;
        
        playbackAudio.currentTime = newTime;
        updateProgress();
        
        if (!playing) {
          playbackAudio.play().then(() => {
            setPauseIcon();
            playing = true;
            updateProgress();
          });
        }
      };

      // æ’­æ”¾/æš‚åœæ§åˆ¶
      btn.onclick = async () => {
        if (!playing) {
          await playbackAudio.play();
          setPauseIcon();
          playing = true;
          updateProgress();
        } else {
          playbackAudio.pause();
          setPlayIcon();
          playing = false;
          cancelAnimationFrame(rafId);
        }
      };

      playbackAudio.onended = () => {
        setPlayIcon();
        playing = false;
        cancelAnimationFrame(rafId);
        bar.style.width = '100%';
      };

      function updateProgress() {
        if (!playing && !isDragging) return;
        const dur = playbackAudio.duration || 0;
        const cur = playbackAudio.currentTime || 0;
        if (dur > 0) {
          const pct = Math.min(100, (cur / dur) * 100);
          bar.style.width = pct + '%';
          const min = Math.floor(cur / 60);
          const sec = Math.floor(cur % 60).toString().padStart(2, '0');
          label.textContent = `${min}:${sec}`;
        }
        if (playing || isDragging) {
          rafId = requestAnimationFrame(updateProgress);
        }
      }

      function setPauseIcon() {
        btn.innerHTML = `<div style="
          width:14px;height:16px;background:#fff;
          clip-path: polygon(
            0 0,0 100%,35% 100%,35% 0,65% 0,65% 100%,100% 100%,100% 0
          );
        "></div>`;
      }

      function setPlayIcon() {
        btn.innerHTML = `<div style="
          width:0;height:0;border-top:9px solid transparent;
          border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;
        "></div>`;
      }
    }

    function closePage() {
      // ç›´æ¥å…³é—­ï¼Œä¸æ˜¾ç¤ºç¡®è®¤æç¤º
      if (document.referrer && document.referrer.includes(location.hostname)) {
        history.back();
      } else {
        window.close();
        // å¦‚æœ window.close() æ— æ•ˆï¼Œè·³è½¬åˆ°é¦–é¡µ
        setTimeout(() => {
          location.href = 'https://report-tan-tau.vercel.app/';
        }, 100);
      }
    }
  </script>
</body>
</html>