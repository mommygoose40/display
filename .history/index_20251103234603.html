<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç½æƒ…å›å ±æŸ¥çœ‹</title>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getStorage, ref, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
      authDomain: "reportsystem-c5fc7.firebaseapp.com",
      projectId: "reportsystem-c5fc7",
      storageBucket: "reportsystem-c5fc7.firebasestorage.app",
      messagingSenderId: "845064058181",
      appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
      measurementId: "G-EDQM0LWQWH"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    window.firebaseStorage = { storage, ref, listAll, getDownloadURL };
  </script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
    .back-btn { background: #4285f4; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 20px; }
    .report-info p { margin: 8px 0; font-size: 16px; }
    .photo-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .photo-item { border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer; }
    .photo-item img { width: 100%; height: 150px; object-fit: cover; transition: transform 0.3s ease; }
    .photo-item:hover img { transform: scale(1.05); }
    .audio-player, .transcription-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #ddd; }
    .transcription-text { background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; white-space: pre-wrap; line-height: 1.5; max-height: 300px; overflow-y: auto; }
    .download-link { display: inline-block; margin-top: 10px; color: #4285f4; text-decoration: none; font-weight: bold; }
    .download-link:hover { text-decoration: underline; }
    .error { text-align: center; color: #d32f2f; font-size: 18px; padding: 40px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
    .modal-content { display: block; margin: auto; max-width: 90%; max-height: 80%; margin-top: 40px; }
    .close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
    .navigation { position: absolute; top: 50%; width: 100%; display: flex; justify-content: space-between; transform: translateY(-50%); }
    .nav-btn { background: rgba(0,0,0,0.5); color: white; border: none; padding: 15px; font-size: 24px; cursor: pointer; }
    .abnormal-tag { display: inline-block; background: #ff4b4b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; font-weight: bold; }
  </style>
</head>

<body>
  <div class="container">
    <button class="back-btn" id="backButton" onclick="handleBack()" style="display: none;">â† è¼‰å…¥ä¸­...</button>

    <div class="header">
      <h1>ç½æƒ…å›å ±è©³ç´°å…§å®¹</h1>
      <p id="report-date">å›å ±æ™‚é–“ï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div class="report-info">
      <h3>å›å ±è³‡è¨Š</h3>
      <p id="report-id">å ±å‘ŠIDï¼šè¼‰å…¥ä¸­...</p>
      <p id="report-type">é€šå ±é¡å‹ï¼šè¼‰å…¥ä¸­...</p>
      <p id="report-status">ç‹€æ…‹ï¼šè¼‰å…¥ä¸­...</p>
      <p id="abnormal-type" style="display:none;">ç•°å¸¸é¡å‹ï¼šè¼‰å…¥ä¸­...</p>
      <p id="remarks">èªªæ˜ï¼šè¼‰å…¥ä¸­...</p>
      <p id="transcription-summary">èªéŸ³è½‰æ–‡å­—ï¼šè¼‰å…¥ä¸­...</p>
      <p id="reporter">å›å ±è€…ï¼šè¼‰å…¥ä¸­...</p>
      <p id="companions">åŒè¡Œè€…ï¼šè¼‰å…¥ä¸­...</p>
      <p id="team">æ‰€å±¬å¤§éšŠï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div id="photo-section">
      <h2>ç…§ç‰‡</h2>
      <div id="photo-gallery" class="photo-gallery"><div class="error">è¼‰å…¥ä¸­...</div></div>
    </div>

    <div id="audio-section" style="display:none;">
      <div class="audio-player">
        <h3>èªéŸ³å›å ±</h3>
        <audio id="audio-player" controls>æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³è¨Šæ’­æ”¾ã€‚</audio>
      </div>
    </div>

    <div id="transcription-section" class="transcription-section" style="display:none;">
      <h3>ğŸ—£ï¸ èªéŸ³è½‰æ–‡å­—çµæœ</h3>
      <div id="transcription-text" class="transcription-text"></div>
      <a id="transcription-download" href="#" class="download-link">ğŸ“¥ ä¸‹è¼‰æ–‡å­—æª”</a>
    </div>

    <div id="image-modal" class="modal">
      <span class="close" onclick="closeModal()">&times;</span>
      <img class="modal-content" id="modal-image">
      <div class="navigation">
        <button class="nav-btn" id="prev-btn" onclick="navigatePhoto(-1)">&#10094;</button>
        <button class="nav-btn" id="next-btn" onclick="navigatePhoto(1)">&#10095;</button>
      </div>
    </div>
  </div>

  <script>
    let currentIndex = 0, currentPhotoUrls = [], currentReportId = '', pageSource = '';

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const reportId = urlParams.get('id');
      pageSource = urlParams.get('source');
      if (reportId) {
        currentReportId = reportId;
        setupBackButton();
        loadReportData(reportId);
      } else showError('éŒ¯èª¤ï¼šæœªæä¾›å ±å‘ŠID');
    });

    function setupBackButton() {
      const btn = document.getElementById('backButton');
      btn.style.display = 'block';
      btn.innerHTML = pageSource === 'form' ? 'â† è¿”å›è¡¨å–®' : 'â† è¿”å›';
    }

    function handleBack() {
      const btn = document.getElementById('backButton');
      btn.innerHTML = 'â† è¿”å›ä¸­...';
      btn.disabled = true;
      if (pageSource === 'form') location.href = 'https://report-tan-tau.vercel.app/';
      else if (document.referrer && document.referrer.includes(location.hostname)) history.back();
      else location.href = 'https://report-tan-tau.vercel.app/';
    }

    async function loadReportData(reportId) {
      try {
        document.getElementById('report-id').textContent = `å ±å‘ŠIDï¼š${reportId}`;
        document.getElementById('report-date').textContent = `å›å ±æ™‚é–“ï¼š${formatDateFromId(reportId)}`;

        // æ¨¡æ“¬å¾è³‡æ–™åº«å–å‡ºæ¬„ä½ (è‹¥å¾Œç«¯æœ‰ firestore å¯æ›æˆå¯¦éš›è³‡æ–™)
        const data = {
          type: 'ç½æƒ…é€šå ±',
          status: 'ç•°å¸¸', // æ­£å¸¸ æˆ– ç•°å¸¸
          abnormalType: 'é“è·¯ä¸­æ–·',
          remarks: 'æ©‹é¢å¡Œé™·ç„¡æ³•é€šè¡Œ',
          transcriptionSummary: 'èªéŸ³å·²è½‰æ–‡å­—',
          reporter: 'ç‹å°æ˜',
          companions: 'æå°è¯ã€å¼µå¤§å±±',
          team: 'ç¬¬ä¸€å¤§éšŠ'
        };

        document.getElementById('report-type').textContent = `é€šå ±é¡å‹ï¼š${data.type || 'æœªå¡«å¯«'}`;
        document.getElementById('report-status').textContent = `ç‹€æ…‹ï¼š${data.status || 'æœªå¡«å¯«'}`;
        if (data.status === 'ç•°å¸¸') {
          const abn = document.getElementById('abnormal-type');
          abn.style.display = 'block';
          abn.textContent = `ç•°å¸¸é¡å‹ï¼š${data.abnormalType || 'æœªæŒ‡å®š'}`;
        } else document.getElementById('abnormal-type').style.display = 'none';
        document.getElementById('remarks').textContent = `èªªæ˜ï¼š${data.remarks || 'æœªæä¾›'}`;
        document.getElementById('transcription-summary').textContent = `èªéŸ³è½‰æ–‡å­—ï¼š${data.transcriptionSummary || 'ç„¡'}`;
        document.getElementById('reporter').textContent = `å›å ±è€…ï¼š${data.reporter || 'æœªæä¾›'}`;
        document.getElementById('companions').textContent = `åŒè¡Œè€…ï¼š${data.companions || 'ç„¡'}`;
        document.getElementById('team').textContent = `æ‰€å±¬å¤§éšŠï¼š${data.team || 'æœªæŒ‡å®š'}`;

        await loadPhotosFromFirebase(reportId);
        await loadAudioFromFirebase(reportId);
        await loadTranscriptionFromFirebase(reportId);
      } catch (e) {
        console.error(e);
        showError('è¼‰å…¥æ•¸æ“šå¤±æ•—');
      }
    }

    function formatDateFromId(reportId) {
      const t = parseInt(reportId.replace('report_', ''));
      return isNaN(t) ? 'æœªçŸ¥æ™‚é–“' : new Date(t).toLocaleString('zh-TW');
    }

    async function loadPhotosFromFirebase(reportId) {
      try {
        const { ref, listAll, getDownloadURL } = window.firebaseStorage;
        const storageRef = ref(window.firebaseStorage.storage, `reports/${reportId}/`);
        const result = await listAll(storageRef);
        const photos = result.items.filter(i => i.name.startsWith('photo_') && /\.(jpg|jpeg|png)$/i.test(i.name));
        if (!photos.length) return document.getElementById('photo-gallery').innerHTML = '<p>æ­¤å›å ±æ²’æœ‰ç…§ç‰‡</p>';
        const urls = [];
        for (const f of photos) urls.push(await getDownloadURL(f));
        displayPhotos(urls);
      } catch (e) {
        console.error(e);
        document.getElementById('photo-gallery').innerHTML = '<p>è¼‰å…¥ç…§ç‰‡å¤±æ•—</p>';
      }
    }

    async function loadAudioFromFirebase(reportId) {
      const { ref, getDownloadURL } = window.firebaseStorage;
      const exts = ['.webm', '.mp3', '.wav', '.m4a'];
      for (const ext of exts) {
        try {
          const r = ref(window.firebaseStorage.storage, `reports/${reportId}/recording${ext}`);
          const url = await getDownloadURL(r);
          document.getElementById('audio-section').style.display = 'block';
          document.getElementById('audio-player').src = url;
          break;
        } catch {}
      }
    }

    async function loadTranscriptionFromFirebase(reportId) {
      try {
        const { ref, getDownloadURL } = window.firebaseStorage;
        const tRef = ref(window.firebaseStorage.storage, `reports/${reportId}/transcription.txt`);
        const url = await getDownloadURL(tRef);
        const text = await (await fetch(url)).text();
        document.getElementById('transcription-section').style.display = 'block';
        document.getElementById('transcription-text').textContent = text;
        document.getElementById('transcription-download').href = url;
        document.getElementById('transcription-download').download = `transcription_${reportId}.txt`;
      } catch {}
    }

    function showError(msg) {
      document.getElementById('photo-gallery').innerHTML = `<div class="error">${msg}</div>`;
    }

    function displayPhotos(urls) {
      const g = document.getElementById('photo-gallery');
      g.innerHTML = '';
      urls.forEach((u, i) => {
        const d = document.createElement('div');
        d.className = 'photo-item';
        d.innerHTML = `<img src="${u}" data-index="${i}">`;
        d.onclick = () => openModal(i, urls);
        g.appendChild(d);
      });
    }

    function openModal(i, urls) {
      currentIndex = i; currentPhotoUrls = urls;
      const m = document.getElementById('image-modal');
      document.getElementById('modal-image').src = urls[i];
      m.style.display = 'block';
    }
    function closeModal() { document.getElementById('image-modal').style.display = 'none'; }
    function navigatePhoto(d) {
      if (d === -1 && currentIndex > 0) currentIndex--;
      else if (d === 1 && currentIndex < currentPhotoUrls.length - 1) currentIndex++;
      document.getElementById('modal-image').src = currentPhotoUrls[currentIndex];
    }
    window.onclick = e => { if (e.target === document.getElementById('image-modal')) closeModal(); };
  </script>
</body>
</html>
